const addKPI = () => {
    if (!isKPIFormValid.value) {
        showNotification('Lengkapi semua field yang diperlukan', 'error');
        return;
    }
    
    // CRITICAL: Lock operations
    isOperationInProgress.value = true;
    
    try {
        const form = kpiForm;
        
        if (form.recurringType === 'monthly') {
            // Check for duplicate recurring templates
            const existingTemplate = kpiData.value.find(kpi => 
                kpi.isRecurring && 
                kpi.title === form.title && 
                kpi.assignedTo === form.assignedTo &&
                kpi.recurringType === 'monthly'
            );
            
            if (existingTemplate) {
                showNotification('KPI berulang dengan judul dan pegawai yang sama sudah ada', 'error');
                return;
            }
            
            // Create recurring template
            const recurringTemplate = {
                id: 'recurring-' + Date.now(),
                title: form.title,
                description: form.description,
                assignedTo: form.assignedTo,
                deadline: null,
                status: 'template',
                createdAt: getCurrentDate(),
                createdBy: currentUser.value.username,
                isRecurring: true,
                recurringType: 'monthly',
                monthlyDeadlineDay: parseInt(form.monthlyDeadlineDay)
            };
            
            kpiData.value.push(recurringTemplate);
            
            // Generate this month's KPI immediately (with duplicate check)
            const currentMonth = getCurrentMonth();
            const monthlyKPIId = `monthly-${recurringTemplate.id}-${currentMonth}`;
            
            // Check if monthly KPI already exists or was deleted
            if (!deletedMonthlyKPIs.value.has(monthlyKPIId)) {
                const monthlyDeadline = `${currentMonth}-${form.monthlyDeadlineDay.toString().padStart(2, '0')}`;
                
                const existingMonthlyKPI = kpiData.value.find(kpi => 
                    kpi.id === monthlyKPIId ||
                    (kpi.title === form.title && 
                     kpi.assignedTo === form.assignedTo && 
                     kpi.deadline === monthlyDeadline)
                );
                
                if (!existingMonthlyKPI) {
                    const deadlineDate = new Date(monthlyDeadline);
                    if (deadlineDate.getMonth() === parseInt(currentMonth.split('-')[1]) - 1) {
                        const currentMonthKPI = {
                            id: monthlyKPIId,
                            title: form.title,
                            description: form.description,
                            assignedTo: form.assignedTo,
                            deadline: monthlyDeadline,
                            status: 'pending',
                            createdAt: getCurrentDate(),
                            createdBy: currentUser.value.username,
                            isRecurring: false,
                            parentRecurringId: recurringTemplate.id,
                            monthlyDeadlineDay: parseInt(form.monthlyDeadlineDay)
                        };
                        
                        kpiData.value.push(currentMonthKPI);
                    }
                }
            }
            
            showNotification('KPI berulang berhasil ditambahkan dan akan otomatis dibuat setiap bulan', 'success');
        } else {
            // Check for duplicate one-time KPIs
            const existingKPI = kpiData.value.find(kpi => 
                !kpi.isRecurring && 
                kpi.title === form.title && 
                kpi.assignedTo === form.assignedTo &&
                kpi.deadline === form.deadline
            );
            
            if (existingKPI) {
                showNotification('KPI dengan detail yang sama sudah ada', 'error');
                return;
            }
            
            // Create one-time KPI
            const newKPI = {
                id: 'kpi-' + Date.now(),
                title: form.title,
                description: form.description,
                assignedTo: form.assignedTo,
                deadline: form.deadline,
                status: 'pending',
                createdAt: getCurrentDate(),
                createdBy: currentUser.value.username,
                isRecurring: false,
                recurringType: 'once'
            };
            
            kpiData.value.push(newKPI);
            showNotification('KPI baru berhasil ditambahkan', 'success');
        }
        
        resetKPIForm();
        saveToStorage();
        
        // Delayed sync
        setTimeout(() => {
            autoSave();
        }, 1000);
        
    } catch (error) {
        console.error('Error adding KPI:', error);
        showNotification('Gagal menambahkan KPI', 'error');
    } finally {
        setTimeout(() => {
            isOperationInProgress.value = false;
        }, 2000);
    }
};
