<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem absen dan KPI Kantor Pusat</title>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #3B82F6; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #2563EB; }

        .dark { background: linear-gradient(135deg, #1a202c 0%, #2d3748 50%, #4a5568 100%); }
        .dark .bg-white { background-color: #2d3748 !important; }
        .dark .bg-gray-50 { background-color: #374151 !important; }
        .dark .text-gray-900 { color: #f7fafc !important; }
        .dark .text-gray-600 { color: #cbd5e0 !important; }
        .dark .border-gray-200 { border-color: #4a5568 !important; }

        .kpi-pending { background-color: #FEF3C7 !important; color: #92400E !important; }
        .dark .kpi-pending { background-color: #78350F !important; color: #FDE68A !important; }
        .kpi-in-progress { background-color: #DBEAFE !important; color: #1E40AF !important; }
        .dark .kpi-in-progress { background-color: #1E3A8A !important; color: #BFDBFE !important; }
        .kpi-completed { background-color: #D1FAE5 !important; color: #065F46 !important; }
        .dark .kpi-completed { background-color: #064E3B !important; color: #A7F3D0 !important; }
        .kpi-overdue { background-color: #FECACA !important; color: #991B1B !important; }
        .dark .kpi-overdue { background-color: #7F1D1D !important; color: #FCA5A5 !important; }

        .kpi-recurring { background-color: #E0E7FF !important; color: #5B21B6 !important; }
        .dark .kpi-recurring { background-color: #4C1D95 !important; color: #C4B5FD !important; }

        .att-on-time { background-color: #D1FAE5 !important; color: #065F46 !important; }
        .dark .att-on-time { background-color: #064E3B !important; color: #A7F3D0 !important; }
        .att-late { background-color: #FFEDD5 !important; color: #9A3412 !important; }
        .dark .att-late { background-color: #7C2D12 !important; color: #FCD34D !important; }
        .att-sick { background-color: #FEF3C7 !important; color: #92400E !important; }
        .dark .att-sick { background-color: #78350F !important; color: #FDE68A !important; }
        .att-permit { background-color: #DBEAFE !important; color: #1E40AF !important; }
        .dark .att-permit { background-color: #1E3A8A !important; color: #BFDBFE !important; }
        .att-field-duty { background-color: #E0E7FF !important; color: #5B21B6 !important; }
        .dark .att-field-duty { background-color: #4C1D95 !important; color: #C4B5FD !important; }
        .att-absent { background-color: #FECACA !important; color: #991B1B !important; }
        .dark .att-absent { background-color: #7F1D1D !important; color: #FCA5A5 !important; }

        @media print { .no-print { display: none !important; } }
        
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        .slide-enter-active, .slide-leave-active { transition: transform 0.2s ease; }
        .slide-enter-from { transform: translateY(-10px); }
        .slide-leave-to { transform: translateY(10px); }

        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }

        .sync-indicator {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .sync-connected {
            background-color: #10B981;
            color: white;
        }
        
        .sync-disconnected {
            background-color: #EF4444;
            color: white;
        }
        
        .sync-syncing {
            background-color: #F59E0B;
            color: white;
        }

        .recurring-pattern {
            background: linear-gradient(45deg, transparent 25%, rgba(139, 92, 246, 0.1) 25%, rgba(139, 92, 246, 0.1) 50%, transparent 50%, transparent 75%, rgba(139, 92, 246, 0.1) 75%);
            background-size: 8px 8px;
        }
    </style>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#eff6ff', 500: '#3B82F6', 600: '#2563EB', 700: '#1d4ed8' }
                    }
                }
            }
        }
    </script>
</head>

<body class="min-h-screen transition-colors duration-200" id="app">
    <!-- Sync Status Indicator -->
    <div class="sync-indicator" 
         :class="{
             'sync-connected': supabaseConnected && !isSyncing,
             'sync-disconnected': !supabaseConnected,
             'sync-syncing': isSyncing
         }">
        <i v-if="supabaseConnected && !isSyncing" class="fas fa-wifi mr-1"></i>
        <i v-else-if="isSyncing" class="fas fa-sync-alt animate-spin mr-1"></i>
        <i v-else class="fas fa-wifi-slash mr-1"></i>
        {{ syncStatusText }}
    </div>

    <!-- Loading Screen -->
    <div v-if="loading" class="fixed inset-0 bg-gradient-to-br from-primary-500 to-blue-600 flex items-center justify-center z-50">
        <div class="text-center text-white">
            <div class="animate-spin rounded-full h-16 w-16 border-4 border-white border-t-transparent mb-4 mx-auto"></div>
            <h2 class="text-2xl font-bold mb-2">Ibnu Katsir Indonesia</h2>
            <p class="text-lg opacity-90">Bismillah...</p>
            <div v-if="supabaseConnected" class="mt-2 text-sm opacity-75">
                <i class="fas fa-database mr-1"></i>Database Connected
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <transition-group name="slide" tag="div" class="fixed top-4 right-4 z-40 space-y-2">
        <div v-for="notification in notifications" 
             :key="notification.id"
             class="max-w-sm rounded-lg shadow-lg p-4 pointer-events-auto"
             :class="getNotificationClass(notification.type)">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <i :class="getNotificationIcon(notification.type)" class="mr-2"></i>
                    <span>{{ notification.message }}</span>
                </div>
                <button @click="removeNotification(notification.id)" class="ml-2 hover:opacity-75">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </transition-group>

    <!-- Employee Management Modal -->
    <div v-if="showEmployeeModal" 
         class="fixed inset-0 z-50 overflow-y-auto modal-overlay"
         @click.self="closeEmployeeModal">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-user-plus mr-2 text-primary-500"></i>
                                {{ editingEmployee ? 'Edit Pegawai' : 'Tambah Pegawai Baru' }}
                            </h3>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        Nama Lengkap <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" 
                                           v-model="employeeForm.name"
                                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                           placeholder="Masukkan nama lengkap">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        Username <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" 
                                           v-model="employeeForm.username"
                                           :disabled="editingEmployee"
                                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white disabled:opacity-50 disabled:cursor-not-allowed"
                                           placeholder="Masukkan username">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        Email <span class="text-red-500">*</span>
                                    </label>
                                    <input type="email" 
                                           v-model="employeeForm.email"
                                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                           placeholder="Masukkan email">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        Password <span class="text-red-500">*</span>
                                    </label>
                                    <div class="relative">
                                        <input :type="showEmployeePassword ? 'text' : 'password'" 
                                               v-model="employeeForm.password"
                                               class="w-full px-3 py-2 pr-10 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                               :placeholder="editingEmployee ? 'Kosongkan jika tidak ingin mengubah password' : 'Masukkan password'">
                                        <button type="button" 
                                                @click="showEmployeePassword = !showEmployeePassword"
                                                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300">
                                            <i :class="showEmployeePassword ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        Posisi/Jabatan
                                    </label>
                                    <input type="text" 
                                           v-model="employeeForm.position"
                                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                           placeholder="Masukkan posisi/jabatan">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        Status
                                    </label>
                                    <select v-model="employeeForm.status"
                                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        <option value="active">Aktif</option>
                                        <option value="inactive">Tidak Aktif</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button @click="saveEmployee()" 
                            :disabled="isSubmitting || !isEmployeeFormValid"
                            :class="isSubmitting || !isEmployeeFormValid ? 'opacity-50 cursor-not-allowed' : 'hover:bg-primary-700'"
                            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary-600 text-base font-medium text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:ml-3 sm:w-auto sm:text-sm">
                        <span v-if="!isSubmitting">
                            <i class="fas fa-save mr-2"></i>
                            {{ editingEmployee ? 'Update' : 'Simpan' }}
                        </span>
                        <span v-else class="flex items-center">
                            <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent mr-2"></div>
                            {{ editingEmployee ? 'Mengupdate...' : 'Menyimpan...' }}
                        </span>
                    </button>
                    
                    <button @click="closeEmployeeModal()" 
                            type="button"
                            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        <i class="fas fa-times mr-2"></i>Batal
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container mx-auto px-4 py-6 max-w-7xl" 
         :class="{ 'bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 dark:from-gray-900 dark:via-gray-800 dark:to-gray-700': true, 'dark': darkMode }">
        
        <!-- Login Screen -->
        <div v-if="!isLoggedIn" class="min-h-screen flex items-center justify-center">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 w-full max-w-md">
                <div class="flex justify-end mb-4">
                    <button @click="toggleDarkMode()" 
                            class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                        <i v-if="!darkMode" class="fas fa-moon"></i>
                        <i v-else class="fas fa-sun"></i>
                    </button>
                </div>

                <div class="text-center mb-8">
                    <div class="mx-auto w-16 h-16 bg-gradient-to-br from-primary-500 to-blue-600 rounded-full flex items-center justify-center mb-4">
                        <i class="fas fa-chart-line text-2xl text-white"></i>
                    </div>
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Absensi, Laporan Harian dan KPI Kantor Pusat</h1>
                    <p class="text-gray-600 dark:text-gray-400">Menjadi Yayasan Pendidikan, Dakwah, dan Sosial terkemuka di Indonesia</p>
                </div>

                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            <i class="fas fa-user mr-2"></i>Username
                        </label>
                        <input type="text" 
                               v-model="credentials.username"
                               @keyup.enter="login"
                               class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                               placeholder="Masukkan username">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            <i class="fas fa-lock mr-2"></i>Password
                        </label>
                        <div class="relative">
                            <input :type="showPassword ? 'text' : 'password'" 
                                   v-model="credentials.password"
                                   @keyup.enter="login"
                                   class="w-full px-4 py-3 pr-12 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                   placeholder="Masukkan password">
                            <button type="button" 
                                    @click="showPassword = !showPassword"
                                    class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300">
                                <i :class="showPassword ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div v-if="loginError" class="mb-4 p-3 bg-red-100 dark:bg-red-900/20 border border-red-300 dark:border-red-700 rounded-lg text-red-700 dark:text-red-300 text-sm">
                    <i class="fas fa-exclamation-circle mr-2"></i>{{ loginError }}
                </div>

                <button @click="login" 
                        :disabled="!credentials.username || !credentials.password || isLoggingIn"
                        :class="!credentials.username || !credentials.password || isLoggingIn ? 'opacity-50 cursor-not-allowed' : 'hover:shadow-lg'"
                        class="w-full bg-gradient-to-r from-primary-500 to-blue-600 text-white py-3 px-6 rounded-xl font-semibold transition-all duration-200">
                    <span v-if="!isLoggingIn">
                        <i class="fas fa-sign-in-alt mr-2"></i>Masuk
                    </span>
                    <span v-else class="flex items-center justify-center">
                        <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent mr-2"></div>
                        Masuk...
                    </span>
                </button>
                
                <!-- Debug Info -->
                <div v-if="isLoggedIn && isAdmin" class="mt-4 text-center">
                    <button @click="testSync" class="text-sm text-blue-500 hover:text-blue-700">
                        Test Sync
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Application -->
        <div v-else class="space-y-6">
            <!-- Header -->
            <div class="bg-gradient-to-r from-primary-500 to-blue-600 rounded-2xl shadow-xl p-6 text-white">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                    <div>
                        <h1 class="text-2xl lg:text-3xl font-bold mb-2">
                            <i class="fas fa-chart-line mr-3"></i>KPI Tracker & Daily Report
                        </h1>
                        <p class="text-lg opacity-90">{{ isAdmin ? 'Panel Administrator' : `Selamat datang, ${currentUser.name}` }}</p>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
                        <div class="bg-white/20 backdrop-blur-sm rounded-xl px-4 py-2 text-center">
                            <div class="text-sm opacity-75">Waktu Jakarta</div>
                            <div class="font-bold text-lg">{{ currentTime }}</div>
                        </div>
                        
                        <button @click="toggleDarkMode()" 
                                class="p-2 rounded-lg bg-white/20 backdrop-blur-sm hover:bg-white/30 transition-colors">
                            <i v-if="!darkMode" class="fas fa-moon"></i>
                            <i v-else class="fas fa-sun"></i>
                        </button>

                        <button @click="logout()" 
                                class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors flex items-center space-x-2">
                            <i class="fas fa-sign-out-alt"></i>
                            <span class="hidden sm:inline">Logout</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-2">
                <nav class="flex flex-wrap gap-2">
                    <!-- ADMIN TABS -->
                    <template v-if="isAdmin">
                        <button @click="activeTab = 'employee-management'" 
                                :class="activeTab === 'employee-management' ? 'bg-primary-500 text-white shadow-md' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'"
                                class="px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center space-x-2">
                            <i class="fas fa-users"></i>
                            <span>Kelola Pegawai</span>
                        </button>

                        <button @click="activeTab = 'kpi-management'" 
                                :class="activeTab === 'kpi-management' ? 'bg-primary-500 text-white shadow-md' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'"
                                class="px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center space-x-2">
                            <i class="fas fa-tasks"></i>
                            <span>Kelola KPI</span>
                        </button>
                        
                        <button @click="activeTab = 'daily-reports'" 
                                :class="activeTab === 'daily-reports' ? 'bg-primary-500 text-white shadow-md' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'"
                                class="px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center space-x-2">
                            <i class="fas fa-clipboard-list"></i>
                            <span>Laporan Harian</span>
                        </button>
                        
                        <button @click="activeTab = 'kpi-recap'" 
                                :class="activeTab === 'kpi-recap' ? 'bg-primary-500 text-white shadow-md' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'"
                                class="px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center space-x-2">
                            <i class="fas fa-chart-bar"></i>
                            <span>Rekap KPI</span>
                        </button>

                        <button @click="activeTab = 'attendance-recap'" 
                                :class="activeTab === 'attendance-recap' ? 'bg-primary-500 text-white shadow-md' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'"
                                class="px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center space-x-2">
                            <i class="fas fa-user-clock"></i>
                            <span>Rekap Absensi</span>
                        </button>
                    </template>
                    
                    <!-- EMPLOYEE TABS -->
                    <template v-else>
                        <button @click="activeTab = 'my-kpi'" 
                                :class="activeTab === 'my-kpi' ? 'bg-primary-500 text-white shadow-md' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'"
                                class="px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center space-x-2">
                            <i class="fas fa-bullseye"></i>
                            <span>KPI Saya</span>
                        </button>
                        
                        <button @click="activeTab = 'attendance'" 
                                :class="activeTab === 'attendance' ? 'bg-primary-500 text-white shadow-md' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'"
                                class="px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center space-x-2">
                            <i class="fas fa-clock"></i>
                            <span>Absensi</span>
                        </button>
                        
                        <button @click="activeTab = 'office-status'" 
                                :class="activeTab === 'office-status' ? 'bg-primary-500 text-white shadow-md' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'"
                                class="px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center space-x-2">
                            <i class="fas fa-building"></i>
                            <span>Status Kantor</span>
                        </button>
                        
                        <button @click="activeTab = 'daily-report'" 
                                :class="activeTab === 'daily-report' ? 'bg-primary-500 text-white shadow-md' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'"
                                class="px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center space-x-2">
                            <i class="fas fa-edit"></i>
                            <span>Laporan Harian</span>
                        </button>
                    </template>
                </nav>
            </div>

            <!-- Content Area -->
            <div class="relative">
                <!-- ADMIN CONTENT ONLY -->
                <template v-if="isAdmin">
                    <!-- Admin Employee Management -->
                    <div v-show="activeTab === 'employee-management'" class="space-y-6">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
                                <h3 class="text-xl font-bold text-gray-900 dark:text-white">
                                    <i class="fas fa-users mr-2 text-primary-500"></i>Manajemen Pegawai
                                </h3>
                                <button @click="openEmployeeModal()" 
                                        class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg font-medium transition-colors flex items-center space-x-2">
                                    <i class="fas fa-user-plus"></i>
                                    <span>Tambah Pegawai</span>
                                </button>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-blue-600 dark:text-blue-400">{{ activeEmployeesCount }}</div>
                                    <div class="text-sm text-blue-600 dark:text-blue-400">Pegawai Aktif</div>
                                </div>
                                <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-green-600 dark:text-green-400">{{ todayPresentCount }}</div>
                                    <div class="text-sm text-green-600 dark:text-green-400">Hadir Hari Ini</div>
                                </div>
                                <div class="bg-yellow-50 dark:bg-yellow-900/20 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-yellow-600 dark:text-yellow-400">{{ pendingKPICount }}</div>
                                    <div class="text-sm text-yellow-600 dark:text-yellow-400">KPI Pending</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
                            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                                <h4 class="text-lg font-bold text-gray-900 dark:text-white">Daftar Pegawai</h4>
                            </div>
                            
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-50 dark:bg-gray-700">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Pegawai</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Username</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Email</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Posisi</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                        <tr v-for="employee in nonAdminEmployees" :key="employee.username" class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="flex items-center">
                                                    <div class="w-10 h-10 bg-primary-500 text-white rounded-full flex items-center justify-center font-semibold text-sm mr-3">
                                                        {{ employee.name.charAt(0).toUpperCase() }}
                                                    </div>
                                                    <div>
                                                        <div class="font-medium text-gray-900 dark:text-white">{{ employee.name }}</div>
                                                        <div class="text-sm text-gray-500 dark:text-gray-400">Bergabung: {{ formatDate(employee.created_at || '2025-01-01') }}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">{{ employee.username }}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">{{ employee.email || '-' }}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">{{ employee.position || '-' }}</td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span :class="(employee.status || 'active') === 'active' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'"
                                                      class="px-2 py-1 text-xs font-medium rounded-full">
                                                    {{ (employee.status || 'active') === 'active' ? 'Aktif' : 'Tidak Aktif' }}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                                <button @click="editEmployee(employee)" 
                                                        class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button @click="toggleEmployeeStatus(employee)" 
                                                        :class="(employee.status || 'active') === 'active' ? 'text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300' : 'text-green-600 hover:text-green-900 dark:text-green-400 dark:hover:text-green-300'">
                                                    <i :class="(employee.status || 'active') === 'active' ? 'fas fa-user-times' : 'fas fa-user-check'"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Admin KPI Management -->
                    <div v-show="activeTab === 'kpi-management'" class="space-y-6">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-6">
                                <i class="fas fa-plus mr-2 text-primary-500"></i>Tambah KPI Baru
                            </h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Judul KPI</label>
                                    <input type="text" 
                                           v-model="kpiForm.title"
                                           class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                           placeholder="Masukkan judul KPI">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Assign ke Pegawai</label>
                                    <select v-model="kpiForm.assignedTo" 
                                            class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        <option value="">-- Pilih Pegawai --</option>
                                        <option v-for="employee in activeEmployees" :key="employee.username" :value="employee.username">
                                            {{ employee.name }}
                                        </option>
                                    </select>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Deskripsi KPI</label>
                                    <textarea v-model="kpiForm.description"
                                              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white resize-none"
                                              rows="3"
                                              placeholder="Jelaskan detail KPI yang harus dicapai..."></textarea>
                                </div>
                                
                                <!-- NEW: KPI Type Selection -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        <i class="fas fa-repeat mr-1"></i>Jenis KPI
                                    </label>
                                    <div class="grid grid-cols-1 gap-2">
                                        <label class="flex items-center p-3 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                                               :class="kpiForm.recurringType === 'once' ? 'border-primary-500 bg-primary-50 dark:bg-primary-900/20' : ''">
                                            <input type="radio" v-model="kpiForm.recurringType" value="once" class="hidden">
                                            <div class="w-4 h-4 border-2 border-gray-300 dark:border-gray-600 rounded-full mr-3 flex items-center justify-center"
                                                 :class="kpiForm.recurringType === 'once' ? 'border-primary-500' : ''">
                                                <div v-if="kpiForm.recurringType === 'once'" class="w-2 h-2 bg-primary-500 rounded-full"></div>
                                            </div>
                                            <div>
                                                <div class="font-medium text-gray-900 dark:text-white">KPI Sekali Saja</div>
                                                <div class="text-sm text-gray-600 dark:text-gray-400">KPI untuk periode tertentu saja</div>
                                            </div>
                                        </label>
                                        
                                        <label class="flex items-center p-3 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                                               :class="kpiForm.recurringType === 'monthly' ? 'border-primary-500 bg-primary-50 dark:bg-primary-900/20' : ''">
                                            <input type="radio" v-model="kpiForm.recurringType" value="monthly" class="hidden">
                                            <div class="w-4 h-4 border-2 border-gray-300 dark:border-gray-600 rounded-full mr-3 flex items-center justify-center"
                                                 :class="kpiForm.recurringType === 'monthly' ? 'border-primary-500' : ''">
                                                <div v-if="kpiForm.recurringType === 'monthly'" class="w-2 h-2 bg-primary-500 rounded-full"></div>
                                            </div>
                                            <div>
                                                <div class="font-medium text-gray-900 dark:text-white">KPI Berulang Bulanan</div>
                                                <div class="text-sm text-gray-600 dark:text-gray-400">Otomatis dibuat setiap bulan</div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        {{ kpiForm.recurringType === 'monthly' ? 'Tanggal Deadline (setiap bulan)' : 'Deadline' }}
                                    </label>
                                    <input v-if="kpiForm.recurringType === 'monthly'" 
                                           type="number" 
                                           v-model="kpiForm.monthlyDeadlineDay"
                                           min="1" max="31"
                                           class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                           placeholder="Contoh: 25 (untuk tanggal 25 setiap bulan)">
                                    <input v-else
                                           type="date" 
                                           v-model="kpiForm.deadline"
                                           :min="getCurrentDate()"
                                           class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <div v-if="kpiForm.recurringType === 'monthly'" class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                        KPI akan otomatis dibuat setiap bulan dengan deadline pada tanggal yang ditentukan
                                    </div>
                                </div>
                                
                                <div class="md:col-span-2 flex items-end">
                                    <button @click="addKPI()" 
                                            :disabled="!isKPIFormValid"
                                            class="w-full px-6 py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                        <i class="fas fa-plus mr-2"></i>Tambah KPI
                                        <span v-if="kpiForm.recurringType === 'monthly'" class="ml-2 text-sm opacity-90">(Berulang)</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
                                <h3 class="text-xl font-bold text-gray-900 dark:text-white">
                                    <i class="fas fa-list mr-2 text-primary-500"></i>Daftar KPI
                                </h3>
                                <div class="flex items-center gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Filter Pegawai</label>
                                        <select v-model="kpiFilter.employee" 
                                                class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                            <option value="">Semua Pegawai</option>
                                            <option v-for="employee in activeEmployees" :key="employee.username" :value="employee.username">
                                                {{ employee.name }}
                                            </option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Filter Jenis</label>
                                        <select v-model="kpiFilter.type" 
                                                class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                            <option value="">Semua Jenis</option>
                                            <option value="once">Sekali Saja</option>
                                            <option value="monthly">Berulang Bulanan</option>
                                        </select>
                                    </div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400 mt-6">
                                        Total: {{ filteredKPIData.length }} KPI
                                    </div>
                                </div>
                            </div>
                            
                            <div class="space-y-4">
                                <div v-for="kpi in filteredKPIData" :key="kpi.id" 
                                     class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:shadow-md transition-shadow"
                                     :class="kpi.isRecurring ? 'recurring-pattern' : ''">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <div class="flex items-center space-x-3 mb-2">
                                                <h4 class="text-lg font-semibold text-gray-900 dark:text-white">{{ kpi.title }}</h4>
                                                <span class="px-2 py-1 text-xs font-medium rounded-full"
                                                      :class="{
                                                          'kpi-completed': kpi.status === 'completed',
                                                          'kpi-in-progress': kpi.status === 'in-progress',
                                                          'kpi-pending': kpi.status === 'pending',
                                                          'kpi-overdue': kpi.status === 'overdue'
                                                      }">
                                                    {{ getKPIStatusLabel(kpi.status) }}
                                                </span>
                                                <span v-if="kpi.isRecurring" class="px-2 py-1 text-xs font-medium rounded-full kpi-recurring">
                                                    <i class="fas fa-repeat mr-1"></i>Berulang
                                                </span>
                                            </div>
                                            <p class="text-gray-600 dark:text-gray-400 mb-3">{{ kpi.description }}</p>
                                            <div class="flex items-center space-x-4 text-sm text-gray-500 dark:text-gray-400">
                                                <div>
                                                    <i class="fas fa-user mr-1"></i>
                                                    {{ getEmployeeName(kpi.assignedTo) }}
                                                </div>
                                                <div>
                                                    <i class="fas fa-calendar mr-1"></i>
                                                    Deadline: {{ formatDate(kpi.deadline) }}
                                                </div>
                                                <div>
                                                    <i class="fas fa-clock mr-1"></i>
                                                    Dibuat: {{ formatDate(kpi.createdAt) }}
                                                </div>
                                                <div v-if="kpi.isRecurring">
                                                    <i class="fas fa-repeat mr-1"></i>
                                                    Setiap tanggal {{ kpi.monthlyDeadlineDay }}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="ml-4 flex space-x-2">
                                            <button @click="editKPI(kpi)" 
                                                    class="px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-medium transition-colors">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button @click="deleteKPI(kpi.id)" 
                                                    class="px-3 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-medium transition-colors">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div v-if="filteredKPIData.length === 0" class="text-center py-12">
                                    <div class="w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <i class="fas fa-tasks text-2xl text-gray-400"></i>
                                    </div>
                                    <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Tidak Ada KPI</h4>
                                    <p class="text-gray-600 dark:text-gray-400">{{ kpiFilter.employee ? 'Tidak ada KPI untuk pegawai yang dipilih.' : 'Mulai buat KPI pertama untuk tim Anda.' }}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Admin Daily Reports -->
                    <div v-show="activeTab === 'daily-reports'" class="space-y-6">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
                                <i class="fas fa-clipboard-list mr-3 text-primary-500"></i>
                                Laporan Harian Pegawai
                            </h2>

                            <div class="flex flex-col md:flex-row gap-4 mb-6">
                                <div class="flex-1">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tanggal</label>
                                    <input type="date" 
                                           v-model="reportFilter.date"
                                           :max="getCurrentDate()"
                                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                                <div class="flex-1">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Pegawai</label>
                                    <select v-model="reportFilter.employee" 
                                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        <option value="">Semua Pegawai</option>
                                        <option v-for="employee in activeEmployees" :key="employee.username" :value="employee.username">
                                            {{ employee.name }}
                                        </option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div v-for="report in filteredDailyReports" :key="report.id" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                                <div class="flex items-start justify-between mb-4">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-10 h-10 bg-primary-500 text-white rounded-full flex items-center justify-center font-semibold">
                                            {{ getEmployeeName(report.employee).charAt(0).toUpperCase() }}
                                        </div>
                                        <div>
                                            <h4 class="font-semibold text-gray-900 dark:text-white">{{ getEmployeeName(report.employee) }}</h4>
                                            <p class="text-sm text-gray-500 dark:text-gray-400">{{ formatDate(report.date) }}</p>
                                        </div>
                                    </div>
                                    <span class="text-sm text-gray-500 dark:text-gray-400">
                                        <i class="fas fa-clock mr-1"></i>{{ formatDateTime(report.timestamp) }}
                                    </span>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                                        <h5 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                                            <i class="fas fa-cog mr-1"></i>Sedang Dikerjakan
                                        </h5>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">{{ report.workingOn }}</p>
                                    </div>
                                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                                        <h5 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                                            <i class="fas fa-check-circle mr-1"></i>Sudah Diselesaikan
                                        </h5>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">{{ report.completed }}</p>
                                    </div>
                                </div>
                            </div>

                            <div v-if="filteredDailyReports.length === 0" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-12 text-center">
                                <div class="w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-clipboard text-2xl text-gray-400"></i>
                                </div>
                                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Tidak Ada Laporan</h3>
                                <p class="text-gray-600 dark:text-gray-400">Tidak ada laporan harian untuk filter yang dipilih.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Admin KPI Recap -->
                    <div v-show="activeTab === 'kpi-recap'" class="space-y-6">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
                                <i class="fas fa-chart-bar mr-3 text-primary-500"></i>
                                Rekap KPI Pegawai
                            </h2>

                            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                                <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-blue-600 dark:text-blue-400">{{ kpiData.length }}</div>
                                    <div class="text-sm text-blue-600 dark:text-blue-400">Total KPI</div>
                                </div>
                                <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-green-600 dark:text-green-400">{{ completedKPIs }}</div>
                                    <div class="text-sm text-green-600 dark:text-green-400">Selesai</div>
                                </div>
                                <div class="bg-yellow-50 dark:bg-yellow-900/20 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-yellow-600 dark:text-yellow-400">{{ inProgressKPIs }}</div>
                                    <div class="text-sm text-yellow-600 dark:text-yellow-400">Dalam Progress</div>
                                </div>
                                <div class="bg-red-50 dark:bg-red-900/20 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-red-600 dark:text-red-400">{{ overdueKPIs }}</div>
                                    <div class="text-sm text-red-600 dark:text-red-400">Terlambat</div>
                                </div>
                                <div class="bg-purple-50 dark:bg-purple-900/20 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-purple-600 dark:text-purple-400">{{ recurringKPIs }}</div>
                                    <div class="text-sm text-purple-600 dark:text-purple-400">Berulang</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-users mr-2 text-primary-500"></i>Progress KPI per Pegawai
                            </h3>

                            <div class="space-y-4">
                                <div v-for="employee in activeEmployees" :key="employee.username" class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center space-x-3">
                                            <div class="w-10 h-10 bg-primary-500 text-white rounded-full flex items-center justify-center font-semibold">
                                                {{ employee.name.charAt(0).toUpperCase() }}
                                            </div>
                                            <div>
                                                <h4 class="font-semibold text-gray-900 dark:text-white">{{ employee.name }}</h4>
                                                <p class="text-sm text-gray-500 dark:text-gray-400">{{ employee.position || 'Staff' }}</p>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-2xl font-bold text-primary-500">{{ getEmployeeKPIProgress(employee.username) }}%</div>
                                            <div class="text-sm text-gray-500 dark:text-gray-400">
                                                {{ getEmployeeKPICount(employee.username, 'completed') }}/{{ getEmployeeKPICount(employee.username) }} KPI
                                            </div>
                                        </div>
                                    </div>

                                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                        <div class="bg-gradient-to-r from-primary-500 to-blue-600 h-2 rounded-full transition-all duration-500" 
                                             :style="`width: ${getEmployeeKPIProgress(employee.username)}%`"></div>
                                    </div>

                                    <div class="mt-3 flex flex-wrap gap-2">
                                        <span v-if="getEmployeeKPICount(employee.username, 'completed') > 0" 
                                              class="px-2 py-1 text-xs bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 rounded-full">
                                            <i class="fas fa-check mr-1"></i>{{ getEmployeeKPICount(employee.username, 'completed') }} Selesai
                                        </span>
                                        <span v-if="getEmployeeKPICount(employee.username, 'in-progress') > 0" 
                                              class="px-2 py-1 text-xs bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 rounded-full">
                                            <i class="fas fa-spinner mr-1"></i>{{ getEmployeeKPICount(employee.username, 'in-progress') }} Progress
                                        </span>
                                        <span v-if="getEmployeeKPICount(employee.username, 'pending') > 0" 
                                              class="px-2 py-1 text-xs bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200 rounded-full">
                                            <i class="fas fa-clock mr-1"></i>{{ getEmployeeKPICount(employee.username, 'pending') }} Pending
                                        </span>
                                        <span v-if="getEmployeeKPICount(employee.username, 'overdue') > 0" 
                                              class="px-2 py-1 text-xs bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200 rounded-full">
                                            <i class="fas fa-exclamation-triangle mr-1"></i>{{ getEmployeeKPICount(employee.username, 'overdue') }} Terlambat
                                        </span>
                                        <span v-if="getEmployeeRecurringKPICount(employee.username) > 0" 
                                              class="px-2 py-1 text-xs bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200 rounded-full">
                                            <i class="fas fa-repeat mr-1"></i>{{ getEmployeeRecurringKPICount(employee.username) }} Berulang
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Admin Attendance Recap -->
                    <div v-show="activeTab === 'attendance-recap'" class="space-y-6">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
                                <i class="fas fa-user-clock mr-3 text-primary-500"></i>
                                Rekap Absensi Pegawai
                            </h2>

                            <div class="flex flex-col md:flex-row gap-4 mb-6">
                                <div class="flex-1">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Bulan</label>
                                    <input type="month" 
                                           v-model="attendanceFilter.month"
                                           :max="getCurrentMonth()"
                                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>

                            <div class="grid grid-cols-2 md:grid-cols-6 gap-4">
                                <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-green-600 dark:text-green-400">{{ monthlyAttendanceStats.onTime }}</div>
                                    <div class="text-xs text-green-600 dark:text-green-400">Tepat Waktu</div>
                                </div>
                                <div class="bg-orange-50 dark:bg-orange-900/20 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-orange-600 dark:text-orange-400">{{ monthlyAttendanceStats.late }}</div>
                                    <div class="text-xs text-orange-600 dark:text-orange-400">Terlambat</div>
                                </div>
                                <div class="bg-purple-50 dark:bg-purple-900/20 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-purple-600 dark:text-purple-400">{{ monthlyAttendanceStats.fieldDuty }}</div>
                                    <div class="text-xs text-purple-600 dark:text-purple-400">Tugas Luar</div>
                                </div>
                                <div class="bg-yellow-50 dark:bg-yellow-900/20 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-yellow-600 dark:text-yellow-400">{{ monthlyAttendanceStats.sick }}</div>
                                    <div class="text-xs text-yellow-600 dark:text-yellow-400">Sakit</div>
                                </div>
                                <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-blue-600 dark:text-blue-400">{{ monthlyAttendanceStats.permit }}</div>
                                    <div class="text-xs text-blue-600 dark:text-blue-400">Izin</div>
                                </div>
                                <div class="bg-red-50 dark:bg-red-900/20 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-red-600 dark:text-red-400">{{ monthlyAttendanceStats.absent }}</div>
                                    <div class="text-xs text-red-600 dark:text-red-400">Tidak Hadir</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
                            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                                <h3 class="text-xl font-bold text-gray-900 dark:text-white">Rekap Absensi Bulanan per Pegawai</h3>
                            </div>
                            
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-50 dark:bg-gray-700">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Pegawai</th>
                                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Tepat Waktu</th>
                                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Terlambat</th>
                                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Tugas Luar</th>
                                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Sakit</th>
                                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Izin</th>
                                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Total Hadir</th>
                                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Kehadiran %</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                        <tr v-for="employee in activeEmployees" :key="employee.username" class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="flex items-center">
                                                    <div class="w-8 h-8 bg-primary-500 text-white rounded-full flex items-center justify-center font-semibold text-xs mr-3">
                                                        {{ employee.name.charAt(0).toUpperCase() }}
                                                    </div>
                                                    <div>
                                                        <div class="text-sm font-medium text-gray-900 dark:text-white">{{ employee.name }}</div>
                                                        <div class="text-xs text-gray-500 dark:text-gray-400">{{ employee.position || 'Staff' }}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 text-center">
                                                <span class="inline-flex items-center justify-center w-8 h-8 bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 rounded-full text-sm font-medium">
                                                    {{ getEmployeeMonthlyAttendance(employee.username)['on-time'] || 0 }}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 text-center">
                                                <span class="inline-flex items-center justify-center w-8 h-8 bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200 rounded-full text-sm font-medium">
                                                    {{ getEmployeeMonthlyAttendance(employee.username)['late'] || 0 }}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 text-center">
                                                <span class="inline-flex items-center justify-center w-8 h-8 bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200 rounded-full text-sm font-medium">
                                                    {{ getEmployeeMonthlyAttendance(employee.username)['field-duty'] || 0 }}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 text-center">
                                                <span class="inline-flex items-center justify-center w-8 h-8 bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200 rounded-full text-sm font-medium">
                                                    {{ getEmployeeMonthlyAttendance(employee.username)['sick'] || 0 }}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 text-center">
                                                <span class="inline-flex items-center justify-center w-8 h-8 bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 rounded-full text-sm font-medium">
                                                    {{ getEmployeeMonthlyAttendance(employee.username)['permit'] || 0 }}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 text-center">
                                                <span class="text-sm font-semibold text-gray-900 dark:text-white">
                                                    {{ getEmployeeMonthlyAttendance(employee.username).total || 0 }}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 text-center">
                                                <div class="flex items-center justify-center">
                                                    <span class="text-sm font-semibold" 
                                                          :class="getEmployeeAttendancePercentage(employee.username) >= 90 ? 'text-green-600 dark:text-green-400' : getEmployeeAttendancePercentage(employee.username) >= 75 ? 'text-yellow-600 dark:text-yellow-400' : 'text-red-600 dark:text-red-400'">
                                                        {{ getEmployeeAttendancePercentage(employee.username) }}%
                                                    </span>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div v-if="activeEmployees.length === 0" class="p-12 text-center">
                                <div class="w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-users text-2xl text-gray-400"></i>
                                </div>
                                <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Tidak Ada Pegawai Aktif</h4>
                                <p class="text-gray-600 dark:text-gray-400">Tambahkan pegawai terlebih dahulu.</p>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- EMPLOYEE CONTENT ONLY -->
                <template v-else>
                    <!-- Employee KPI Dashboard -->
                    <div v-show="activeTab === 'my-kpi'" class="space-y-6">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
                                    <i class="fas fa-bullseye mr-3 text-primary-500"></i>
                                    KPI Saya
                                </h2>
                                <div class="text-right">
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Progress Keseluruhan</div>
                                    <div class="text-3xl font-bold text-primary-500">{{ kpiProgress }}%</div>
                                </div>
                            </div>
                            
                            <div class="mb-6">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Completed</span>
                                    <span class="text-sm text-gray-600 dark:text-gray-400">{{ completedKPICount }} dari {{ myKPIs.length }} KPI</span>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3">
                                    <div class="bg-gradient-to-r from-green-500 to-green-600 h-3 rounded-full transition-all duration-500" 
                                         :style="`width: ${kpiProgress}%`"></div>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div v-for="kpi in myKPIs" :key="kpi.id" 
                                 class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border-l-4"
                                 :class="{
                                     'border-green-500': kpi.status === 'completed',
                                     'border-blue-500': kpi.status === 'in-progress',
                                     'border-yellow-500': kpi.status === 'pending',
                                     'border-red-500': kpi.status === 'overdue',
                                     'recurring-pattern': kpi.isRecurring
                                 }">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-3 mb-2">
                                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">{{ kpi.title }}</h3>
                                            <span class="px-2 py-1 text-xs font-medium rounded-full"
                                                  :class="{
                                                      'kpi-completed': kpi.status === 'completed',
                                                      'kpi-in-progress': kpi.status === 'in-progress',
                                                      'kpi-pending': kpi.status === 'pending',
                                                      'kpi-overdue': kpi.status === 'overdue'
                                                  }">
                                                {{ getKPIStatusLabel(kpi.status) }}
                                            </span>
                                            <span v-if="kpi.isRecurring" class="px-2 py-1 text-xs font-medium rounded-full kpi-recurring">
                                                <i class="fas fa-repeat mr-1"></i>Berulang
                                            </span>
                                        </div>
                                        <p class="text-gray-600 dark:text-gray-400 mb-3">{{ kpi.description }}</p>
                                        <div class="flex items-center space-x-4 text-sm text-gray-500 dark:text-gray-400">
                                            <div>
                                                <i class="fas fa-calendar mr-1"></i>
                                                Deadline: {{ formatDate(kpi.deadline) }}
                                            </div>
                                            <div>
                                                <i class="fas fa-user mr-1"></i>
                                                Dibuat: {{ formatDate(kpi.createdAt) }}
                                            </div>
                                            <div v-if="kpi.isRecurring">
                                                <i class="fas fa-repeat mr-1"></i>
                                                Setiap tanggal {{ kpi.monthlyDeadlineDay }}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="ml-4">
                                        <button @click="toggleKPIStatus(kpi.id)" 
                                                :class="kpi.status === 'completed' ? 'bg-green-500 hover:bg-green-600' : 'bg-blue-500 hover:bg-blue-600'"
                                                class="px-4 py-2 text-white rounded-lg font-medium transition-colors flex items-center space-x-2">
                                            <i :class="kpi.status === 'completed' ? 'fas fa-check' : 'fas fa-play'"></i>
                                            <span>{{ kpi.status === 'completed' ? 'Selesai' : 'Mulai' }}</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div v-if="myKPIs.length === 0" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-12 text-center">
                                <div class="w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-clipboard-list text-2xl text-gray-400"></i>
                                </div>
                                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Belum Ada KPI</h3>
                                <p class="text-gray-600 dark:text-gray-400">Admin belum menetapkan KPI untuk Anda.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Employee Attendance -->
                    <div v-show="activeTab === 'attendance'" class="space-y-6">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
                                <i class="fas fa-clock mr-3 text-primary-500"></i>
                                Absensi Hari Ini - {{ getCurrentDateString() }}
                            </h2>
                            
                            <div v-if="todayAttendance" class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-6 mb-6">
                                <div class="flex items-center space-x-3 mb-4">
                                    <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center">
                                        <i class="fas fa-check text-white text-xl"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-semibold text-green-800 dark:text-green-200">Absensi Hari Ini Sudah Tercatat</h3>
                                        <p class="text-green-600 dark:text-green-300">
                                            Status: {{ getAttendanceStatusLabel(todayAttendance.status) }} | 
                                            Waktu: {{ formatDateTime(todayAttendance.timestamp) }}
                                        </p>
                                        <p v-if="todayAttendance.description" class="text-green-600 dark:text-green-300 mt-1">
                                            Keterangan: {{ todayAttendance.description }}
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <div v-else class="space-y-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
                                        <i class="fas fa-user-check mr-2"></i>Status Absensi
                                    </label>
                                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                                        <button @click="attendanceForm.status = 'on-time'" 
                                                :class="attendanceForm.status === 'on-time' ? 'bg-green-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300'"
                                                class="p-3 rounded-lg font-medium transition-colors flex flex-col items-center space-y-1">
                                            <i class="fas fa-check-circle text-lg"></i>
                                            <span class="text-sm">Tepat Waktu</span>
                                        </button>
                                        <button @click="attendanceForm.status = 'late'" 
                                                :class="attendanceForm.status === 'late' ? 'bg-orange-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300'"
                                                class="p-3 rounded-lg font-medium transition-colors flex flex-col items-center space-y-1">
                                            <i class="fas fa-clock text-lg"></i>
                                            <span class="text-sm">Terlambat</span>
                                        </button>
                                        <button @click="attendanceForm.status = 'field-duty'" 
                                                :class="attendanceForm.status === 'field-duty' ? 'bg-purple-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300'"
                                                class="p-3 rounded-lg font-medium transition-colors flex flex-col items-center space-y-1">
                                            <i class="fas fa-road text-lg"></i>
                                            <span class="text-sm">Tugas Luar</span>
                                        </button>
                                        <button @click="attendanceForm.status = 'sick'" 
                                                :class="attendanceForm.status === 'sick' ? 'bg-yellow-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300'"
                                                class="p-3 rounded-lg font-medium transition-colors flex flex-col items-center space-y-1">
                                            <i class="fas fa-thermometer-half text-lg"></i>
                                            <span class="text-sm">Sakit</span>
                                        </button>
                                        <button @click="attendanceForm.status = 'permit'" 
                                                :class="attendanceForm.status === 'permit' ? 'bg-blue-500 text-white' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300'"
                                                class="p-3 rounded-lg font-medium transition-colors flex flex-col items-center space-y-1">
                                            <i class="fas fa-hand-paper text-lg"></i>
                                            <span class="text-sm">Izin</span>
                                        </button>
                                    </div>
                                </div>

                                <div v-if="attendanceForm.status && needsDescription">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
                                        <i class="fas fa-comment mr-2"></i>Keterangan/Alasan
                                    </label>
                                    <textarea v-model="attendanceForm.description"
                                              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white resize-none"
                                              rows="3"
                                              :placeholder="getDescriptionPlaceholder(attendanceForm.status)"></textarea>
                                </div>

                                <div class="flex space-x-3">
                                    <button @click="submitAttendance()" 
                                            :disabled="!attendanceForm.status || (needsDescription && !attendanceForm.description.trim()) || isSubmitting"
                                            :class="!attendanceForm.status || (needsDescription && !attendanceForm.description.trim()) || isSubmitting ? 'opacity-50 cursor-not-allowed' : 'hover:shadow-lg'"
                                            class="flex-1 bg-gradient-to-r from-primary-500 to-blue-600 text-white py-3 px-6 rounded-lg font-semibold transition-all duration-200">
                                        <span v-if="!isSubmitting">
                                            <i class="fas fa-user-check mr-2"></i>Submit Absensi
                                        </span>
                                        <span v-else class="flex items-center justify-center">
                                            <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent mr-2"></div>
                                            Menyimpan...
                                        </span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-history mr-2 text-primary-500"></i>Riwayat Absensi
                            </h3>
                            
                            <div class="space-y-4">
                                <div v-for="attendance in myAttendanceHistory.slice(0, 10)" :key="attendance.date" class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <h4 class="font-semibold text-gray-900 dark:text-white">{{ formatDate(attendance.date) }}</h4>
                                        <div class="flex items-center space-x-3">
                                            <span class="px-2 py-1 text-xs font-medium rounded-full"
                                                  :class="{
                                                      'att-on-time': attendance.status === 'on-time',
                                                      'att-late': attendance.status === 'late',
                                                      'att-field-duty': attendance.status === 'field-duty',
                                                      'att-sick': attendance.status === 'sick',
                                                      'att-permit': attendance.status === 'permit'
                                                  }">
                                                {{ getAttendanceStatusLabel(attendance.status) }}
                                            </span>
                                            <span class="text-sm text-gray-500 dark:text-gray-400">{{ formatDateTime(attendance.timestamp) }}</span>
                                        </div>
                                    </div>
                                    <p v-if="attendance.description" class="text-sm text-gray-600 dark:text-gray-400">{{ attendance.description }}</p>
                                </div>
                                
                                <div v-if="myAttendanceHistory.length === 0" class="text-center py-8">
                                    <div class="w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <i class="fas fa-user-clock text-2xl text-gray-400"></i>
                                    </div>
                                    <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Belum Ada Absensi</h4>
                                    <p class="text-gray-600 dark:text-gray-400">Mulai catat absensi harian Anda.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Office Status Tab -->
                    <div v-show="activeTab === 'office-status'" class="space-y-6">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
                                <i class="fas fa-building mr-3 text-primary-500"></i>
                                Status Kantor Hari Ini - {{ getCurrentDateString() }}
                            </h2>
                            
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-green-600 dark:text-green-400">{{ todayOfficeStats.present }}</div>
                                    <div class="text-sm text-green-600 dark:text-green-400">Hadir</div>
                                </div>
                                <div class="bg-purple-50 dark:bg-purple-900/20 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-purple-600 dark:text-purple-400">{{ todayOfficeStats.fieldDuty }}</div>
                                    <div class="text-sm text-purple-600 dark:text-purple-400">Tugas Luar</div>
                                </div>
                                <div class="bg-yellow-50 dark:bg-yellow-900/20 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-yellow-600 dark:text-yellow-400">{{ todayOfficeStats.sick }}</div>
                                    <div class="text-sm text-yellow-600 dark:text-yellow-400">Sakit</div>
                                </div>
                                <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-blue-600 dark:text-blue-400">{{ todayOfficeStats.permit }}</div>
                                    <div class="text-sm text-blue-600 dark:text-blue-400">Izin</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-users mr-2 text-primary-500"></i>Status Pegawai
                            </h3>
                            
                            <div class="space-y-3">
                                <div v-for="employee in activeEmployees" :key="employee.username" class="flex items-center justify-between p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-10 h-10 bg-primary-500 text-white rounded-full flex items-center justify-center font-semibold">
                                            {{ employee.name.charAt(0).toUpperCase() }}
                                        </div>
                                        <div>
                                            <h4 class="font-semibold text-gray-900 dark:text-white">{{ employee.name }}</h4>
                                            <p class="text-sm text-gray-600 dark:text-gray-400">
                                                {{ getEmployeeTodayAttendance(employee.username)?.timestamp ? formatDateTime(getEmployeeTodayAttendance(employee.username).timestamp) : 'Belum absen' }}
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <div class="text-right">
                                        <div v-if="getEmployeeTodayAttendance(employee.username)">
                                            <span class="px-3 py-1 text-sm font-medium rounded-full"
                                                  :class="{
                                                      'att-on-time': getEmployeeTodayAttendance(employee.username).status === 'on-time',
                                                      'att-late': getEmployeeTodayAttendance(employee.username).status === 'late',
                                                      'att-field-duty': getEmployeeTodayAttendance(employee.username).status === 'field-duty',
                                                      'att-sick': getEmployeeTodayAttendance(employee.username).status === 'sick',
                                                      'att-permit': getEmployeeTodayAttendance(employee.username).status === 'permit'
                                                  }">
                                                {{ getAttendanceStatusLabel(getEmployeeTodayAttendance(employee.username).status) }}
                                            </span>
                                            <p v-if="getEmployeeTodayAttendance(employee.username).description" class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                                {{ getEmployeeTodayAttendance(employee.username).description }}
                                            </p>
                                        </div>
                                        <span v-else class="px-3 py-1 text-sm font-medium rounded-full bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400">
                                            Belum Absen
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Employee Daily Report -->
                    <div v-show="activeTab === 'daily-report'" class="space-y-6">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
                                <i class="fas fa-edit mr-3 text-primary-500"></i>
                                Laporan Harian - {{ getCurrentDateString() }}
                            </h2>
                            
                            <div v-if="todayReport && !showEditReport" class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-6 mb-6">
                                <div class="flex items-center space-x-3 mb-4">
                                    <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center">
                                        <i class="fas fa-check text-white text-xl"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-semibold text-green-800 dark:text-green-200">Laporan Hari Ini Sudah Dikirim</h3>
                                        <p class="text-green-600 dark:text-green-300">Dikirim pada: {{ formatDateTime(todayReport.timestamp) }}</p>
                                    </div>
                                </div>
                                
                                <button @click="showEditReport = true" 
                                        class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-colors">
                                    <i class="fas fa-edit mr-2"></i>Edit Laporan
                                </button>
                            </div>

                            <div v-if="!todayReport || showEditReport" class="space-y-6">
                                <div v-if="showEditReport" class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4 mb-4">
                                    <p class="text-yellow-800 dark:text-yellow-200">
                                        <i class="fas fa-exclamation-triangle mr-2"></i>
                                        Mode edit: Anda akan mengubah laporan yang sudah ada
                                    </p>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
                                        <i class="fas fa-cog mr-2"></i>Apa yang sedang dikerjakan hari ini?
                                    </label>
                                    <textarea v-model="reportForm.workingOn"
                                              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white resize-none"
                                              rows="4"
                                              placeholder="Jelaskan pekerjaan atau tugas yang sedang Anda kerjakan hari ini..."></textarea>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
                                        <i class="fas fa-check-circle mr-2"></i>Apa yang sudah diselesaikan hari ini?
                                    </label>
                                    <textarea v-model="reportForm.completed"
                                              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white resize-none"
                                              rows="4"
                                              placeholder="Jelaskan pekerjaan atau tugas yang sudah Anda selesaikan hari ini..."></textarea>
                                </div>

                                <div class="flex space-x-3">
                                    <button @click="submitDailyReport()" 
                                            :disabled="!reportForm.workingOn.trim() || !reportForm.completed.trim() || isSubmitting"
                                            :class="!reportForm.workingOn.trim() || !reportForm.completed.trim() || isSubmitting ? 'opacity-50 cursor-not-allowed' : 'hover:shadow-lg'"
                                            class="flex-1 bg-gradient-to-r from-primary-500 to-blue-600 text-white py-3 px-6 rounded-lg font-semibold transition-all duration-200">
                                        <span v-if="!isSubmitting">
                                            <i class="fas fa-paper-plane mr-2"></i>
                                            {{ showEditReport ? 'Update Laporan' : 'Kirim Laporan' }}
                                        </span>
                                        <span v-else class="flex items-center justify-center">
                                            <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent mr-2"></div>
                                            {{ showEditReport ? 'Mengupdate...' : 'Mengirim...' }}
                                        </span>
                                    </button>
                                    
                                    <button v-if="showEditReport" @click="cancelEditReport()" 
                                            class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-semibold transition-colors">
                                        <i class="fas fa-times mr-2"></i>Batal
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-history mr-2 text-primary-500"></i>Riwayat Laporan
                            </h3>
                            
                            <div class="space-y-4">
                                <div v-for="report in myReports.slice(0, 5)" :key="report.date" class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <h4 class="font-semibold text-gray-900 dark:text-white">{{ formatDate(report.date) }}</h4>
                                        <span class="text-sm text-gray-500 dark:text-gray-400">{{ formatDateTime(report.timestamp) }}</span>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Sedang dikerjakan:</h5>
                                            <p class="text-sm text-gray-600 dark:text-gray-400">{{ report.workingOn }}</p>
                                        </div>
                                        <div>
                                            <h5 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Sudah diselesaikan:</h5>
                                            <p class="text-sm text-gray-600 dark:text-gray-400">{{ report.completed }}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div v-if="myReports.length === 0" class="text-center py-8">
                                    <div class="w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <i class="fas fa-file-alt text-2xl text-gray-400"></i>
                                    </div>
                                    <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Belum Ada Laporan</h4>
                                    <p class="text-gray-600 dark:text-gray-400">Mulai buat laporan harian pertama Anda.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch, reactive, nextTick } = Vue;

        // SUPABASE CONFIGURATION - FIXED
        const SUPABASE_CONFIG = {
            url: 'https://yomyurzyuuhbxgvfujqv.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlvbXl1cnp5dXVoYnhndmZ1anF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3NTg0MjUsImV4cCI6MjA2ODMzNDQyNX0.a4yRFDzdj8p5SIP--nBKItwVLtg_qB1ZS0G-NMf95k4'
        };

        const app = createApp({
            setup() {
                // Core state
                const loading = ref(true);
                const isLoggedIn = ref(false);
                const isAdmin = ref(false);
                const currentUser = ref(null);
                const activeTab = ref('my-kpi');
                const darkMode = ref(false);
                const currentTime = ref('');
                const autoSaving = ref(false);
                const isSubmitting = ref(false);
                const isLoggingIn = ref(false);
                const loginError = ref('');

                // Supabase state
                const supabase = ref(null);
                const supabaseConnected = ref(false);
                const isSyncing = ref(false);
                const realtimeSubscriptions = ref([]);

                // UI state
                const showEmployeeModal = ref(false);
                const editingEmployee = ref(null);
                const showEmployeePassword = ref(false);
                const showEditReport = ref(false);
                const showPassword = ref(false);

                // Forms
                const credentials = reactive({
                    username: '',
                    password: ''
                });

                const employeeForm = reactive({
                    name: '',
                    username: '',
                    email: '',
                    password: '',
                    position: '',
                    status: 'active'
                });

                const kpiForm = reactive({
                    title: '',
                    description: '',
                    assignedTo: '',
                    deadline: '',
                    recurringType: 'once', // NEW: 'once' or 'monthly'
                    monthlyDeadlineDay: 31 // NEW: day of month for recurring KPIs
                });

                const kpiFilter = reactive({
                    employee: '',
                    type: '' // NEW: filter by recurring type
                });

                const attendanceForm = reactive({
                    status: '',
                    description: ''
                });

                const reportForm = reactive({
                    workingOn: '',
                    completed: ''
                });

                const reportFilter = reactive({
                    date: getCurrentDate(),
                    employee: ''
                });

                const attendanceFilter = reactive({
                    month: getCurrentMonth(),
                    employee: ''
                });

                // Data
                const employees = ref([
                    { 
                        id: 'admin-1', username: 'admin', password: 'admin123', 
                        name: 'Administrator', email: 'admin@ibnukatsir.com',
                        position: 'Administrator', status: 'active', created_at: '2025-01-01'
                    }
                ]);

                const kpiData = ref([]);
                const dailyReports = ref({});
                const attendanceData = ref({});
                const notifications = ref([]);

                // Computed properties
                const syncStatusText = computed(() => {
                    if (isSyncing.value) return 'Syncing...';
                    if (supabaseConnected.value) return 'Online';
                    return 'Offline';
                });

                const activeEmployees = computed(() => 
                    employees.value.filter(emp => emp.username !== 'admin' && (emp.status || 'active') === 'active')
                );

                const nonAdminEmployees = computed(() => 
                    employees.value.filter(emp => emp.username !== 'admin')
                );

                const activeEmployeesCount = computed(() => activeEmployees.value.length);

                const todayPresentCount = computed(() => {
                    const today = getCurrentDate();
                    let presentCount = 0;
                    
                    activeEmployees.value.forEach(employee => {
                        const attendance = attendanceData.value[employee.username]?.[today];
                        if (attendance && ['on-time', 'late', 'field-duty'].includes(attendance.status)) {
                            presentCount++;
                        }
                    });
                    
                    return presentCount;
                });

                const pendingKPICount = computed(() => 
                    kpiData.value.filter(kpi => kpi.status === 'pending').length
                );

                const myKPIs = computed(() => {
                    if (!currentUser.value) return [];
                    updateKPIStatuses();
                    return kpiData.value.filter(kpi => kpi.assignedTo === currentUser.value.username);
                });

                const kpiProgress = computed(() => {
                    const kpis = myKPIs.value;
                    if (kpis.length === 0) return 0;
                    const completed = kpis.filter(kpi => kpi.status === 'completed').length;
                    return Math.round((completed / kpis.length) * 100);
                });

                const isEmployeeFormValid = computed(() => {
                    const form = employeeForm;
                    if (!form.name.trim() || !form.username.trim() || !form.email.trim()) {
                        return false;
                    }
                    
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(form.email)) {
                        return false;
                    }

                    if (!editingEmployee.value && !form.password.trim()) {
                        return false;
                    }

                    if (!editingEmployee.value) {
                        const existingUser = employees.value.find(emp => emp.username === form.username.trim());
                        if (existingUser) {
                            return false;
                        }
                    }

                    return true;
                });

                // NEW: KPI Form validation
                const isKPIFormValid = computed(() => {
                    const form = kpiForm;
                    if (!form.title || !form.assignedTo || !form.recurringType) {
                        return false;
                    }
                    
                    if (form.recurringType === 'once' && !form.deadline) {
                        return false;
                    }
                    
                    if (form.recurringType === 'monthly' && (!form.monthlyDeadlineDay || form.monthlyDeadlineDay < 1 || form.monthlyDeadlineDay > 31)) {
                        return false;
                    }
                    
                    return true;
                });

                // Helper functions
                function getJakartaDate() {
                    const now = new Date();
                    const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
                    return new Date(utc + (7 * 3600000)); // UTC+7
                }

                function getCurrentDate() {
                    return getJakartaDate().toISOString().split('T')[0];
                }

                function getCurrentMonth() {
                    return getJakartaDate().toISOString().split('T')[0].substring(0, 7);
                }

                const getCurrentDateString = () => {
                    const jakarta = getJakartaDate();
                    return jakarta.toLocaleDateString('id-ID', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                };

                const updateCurrentTime = () => {
                    const jakarta = getJakartaDate();
                    currentTime.value = jakarta.toLocaleString('id-ID', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                };

                const formatDate = (dateString) => {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('id-ID', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                };

                const formatDateTime = (isoString) => {
                    const date = new Date(isoString);
                    return date.toLocaleString('id-ID', {
                        weekday: 'short',
                        day: 'numeric',
                        month: 'short',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                };

                // NEW: Generate monthly KPIs for recurring templates
                const generateMonthlyKPIs = () => {
                    const currentMonth = getCurrentMonth();
                    const [year, month] = currentMonth.split('-');
                    const currentDay = parseInt(getCurrentDate().split('-')[2]);
                    
                    // Find recurring KPI templates
                    const recurringTemplates = kpiData.value.filter(kpi => kpi.isRecurring && kpi.recurringType === 'monthly');
                    
                    recurringTemplates.forEach(template => {
                        // Check if KPI for this month already exists
                        const monthlyKPIExists = kpiData.value.some(kpi => 
                            kpi.parentRecurringId === template.id && 
                            kpi.deadline.startsWith(currentMonth)
                        );
                        
                        // Create monthly KPI if it doesn't exist and we're past the 1st of the month
                        if (!monthlyKPIExists && currentDay >= 1) {
                            const monthlyDeadline = `${currentMonth}-${template.monthlyDeadlineDay.toString().padStart(2, '0')}`;
                            
                            // Validate the date exists in this month
                            const deadlineDate = new Date(monthlyDeadline);
                            if (deadlineDate.getMonth() === parseInt(month) - 1) {
                                const newMonthlyKPI = {
                                    id: `monthly-${template.id}-${currentMonth}`,
                                    title: template.title,
                                    description: template.description,
                                    assignedTo: template.assignedTo,
                                    deadline: monthlyDeadline,
                                    status: 'pending',
                                    createdAt: getCurrentDate(),
                                    createdBy: template.createdBy,
                                    isRecurring: false,
                                    parentRecurringId: template.id,
                                    monthlyDeadlineDay: template.monthlyDeadlineDay
                                };
                                
                                kpiData.value.push(newMonthlyKPI);
                                console.log('Generated monthly KPI:', newMonthlyKPI);
                            }
                        }
                    });
                };

                // Notifications
                const showNotification = (message, type = 'info', duration = 5000) => {
                    const id = Date.now() + Math.random();
                    const notification = { id, message, type };
                    
                    notifications.value.push(notification);
                    
                    if (duration > 0) {
                        setTimeout(() => removeNotification(id), duration);
                    }
                    
                    return id;
                };

                const removeNotification = (id) => {
                    const index = notifications.value.findIndex(n => n.id === id);
                    if (index > -1) {
                        notifications.value.splice(index, 1);
                    }
                };

                const getNotificationClass = (type) => {
                    const classes = {
                        'success': 'bg-green-500 text-white',
                        'error': 'bg-red-500 text-white',
                        'info': 'bg-blue-500 text-white',
                        'warning': 'bg-yellow-500 text-white'
                    };
                    return classes[type] || classes.info;
                };

                const getNotificationIcon = (type) => {
                    const icons = {
                        'success': 'fas fa-check-circle',
                        'error': 'fas fa-exclamation-circle',
                        'info': 'fas fa-info-circle',
                        'warning': 'fas fa-exclamation-triangle'
                    };
                    return icons[type] || icons.info;
                };

                // SUPABASE FUNCTIONS - FIXED
                const initSupabase = async () => {
                    try {
                        console.log('🔄 Initializing Supabase connection...');
                        
                        supabase.value = window.supabase.createClient(
                            SUPABASE_CONFIG.url, 
                            SUPABASE_CONFIG.key
                        );
                        
                        // Test connection
                        console.log('🔍 Testing Supabase connection...');
                        const { data, error } = await supabase.value
                            .from('employees')
                            .select('id')
                            .limit(1);

                        if (error) {
                            console.error('❌ Supabase connection test failed:', error);
                            throw error;
                        }

                        supabaseConnected.value = true;
                        console.log('✅ Supabase connected successfully');
                        showNotification('Database terhubung', 'success');
                        
                        // Setup realtime subscriptions
                        setupRealtimeSubscriptions();
                        
                        // Initial sync from Supabase
                        await syncFromSupabase();
                        
                    } catch (error) {
                        console.error('❌ Supabase initialization failed:', error);
                        supabaseConnected.value = false;
                        showNotification('Database offline, menggunakan penyimpanan lokal', 'warning');
                    }
                };

                const setupRealtimeSubscriptions = () => {
                    if (!supabase.value || !supabaseConnected.value) return;

                    console.log('🔔 Setting up realtime subscriptions...');

                    try {
                        // Subscribe to all table changes
                        const channel = supabase.value
                            .channel('db-changes')
                            .on('postgres_changes', 
                                { event: '*', schema: 'public', table: 'employees' }, 
                                (payload) => {
                                    console.log('Employee change:', payload);
                                    setTimeout(() => syncFromSupabase(), 500);
                                }
                            )
                            .on('postgres_changes', 
                                { event: '*', schema: 'public', table: 'kpi' }, 
                                (payload) => {
                                    console.log('KPI change:', payload);
                                    setTimeout(() => syncFromSupabase(), 500);
                                }
                            )
                            .on('postgres_changes', 
                                { event: '*', schema: 'public', table: 'attendance' }, 
                                (payload) => {
                                    console.log('Attendance change:', payload);
                                    setTimeout(() => syncFromSupabase(), 500);
                                }
                            )
                            .on('postgres_changes', 
                                { event: '*', schema: 'public', table: 'daily_reports' }, 
                                (payload) => {
                                    console.log('Report change:', payload);
                                    setTimeout(() => syncFromSupabase(), 500);
                                }
                            )
                            .subscribe((status) => {
                                console.log('Realtime subscription status:', status);
                            });

                        realtimeSubscriptions.value = [channel];
                        console.log('✅ Realtime subscriptions setup complete');
                    } catch (error) {
                        console.error('❌ Error setting up realtime subscriptions:', error);
                    }
                };

                const syncFromSupabase = async () => {
                    if (!supabaseConnected.value || isSyncing.value) return;
                    
                    isSyncing.value = true;
                    console.log('🔄 Starting sync from Supabase...');
                    
                    try {
                        // Sync employees
                        const { data: employeesData, error: empError } = await supabase.value
                            .from('employees')
                            .select('*')
                            .order('created_at', { ascending: true });

                        if (empError) throw empError;

                        if (employeesData && employeesData.length > 0) {
                            const adminUser = employees.value.find(emp => emp.username === 'admin');
                            const mergedEmployees = adminUser ? [adminUser] : [];
                            
                            employeesData.forEach(emp => {
                                if (emp.username !== 'admin') {
                                    mergedEmployees.push(emp);
                                }
                            });
                            
                            employees.value = mergedEmployees;
                            console.log('✅ Employees synced:', employees.value.length);
                        }

                        // Sync KPI data with new recurring fields
                        const { data: kpiDataFromDB, error: kpiError } = await supabase.value
                            .from('kpi')
                            .select('*')
                            .order('created_at', { ascending: true });

                        if (kpiError) throw kpiError;

                        if (kpiDataFromDB) {
                            kpiData.value = kpiDataFromDB.map(kpi => ({
                                ...kpi,
                                assignedTo: kpi.assigned_to,
                                createdAt: kpi.created_at,
                                createdBy: kpi.created_by,
                                isRecurring: kpi.is_recurring || false,
                                recurringType: kpi.recurring_type || 'once',
                                monthlyDeadlineDay: kpi.monthly_deadline_day || null,
                                parentRecurringId: kpi.parent_recurring_id || null
                            }));
                            console.log('✅ KPI data synced:', kpiData.value.length);
                        }

                        // Sync attendance data
                        const { data: attendanceDataFromDB, error: attError } = await supabase.value
                            .from('attendance')
                            .select('*')
                            .order('date', { ascending: false });

                        if (attError) throw attError;

                        if (attendanceDataFromDB) {
                            const reorganizedAttendance = {};
                            attendanceDataFromDB.forEach(record => {
                                if (!reorganizedAttendance[record.employee]) {
                                    reorganizedAttendance[record.employee] = {};
                                }
                                reorganizedAttendance[record.employee][record.date] = record;
                            });
                            attendanceData.value = reorganizedAttendance;
                            console.log('✅ Attendance data synced:', attendanceDataFromDB.length, 'records');
                        }

                        // Sync daily reports
                        const { data: reportsDataFromDB, error: repError } = await supabase.value
                            .from('daily_reports')
                            .select('*')
                            .order('date', { ascending: false });

                        if (repError) throw repError;

                        if (reportsDataFromDB) {
                            const reorganizedReports = {};
                            reportsDataFromDB.forEach(record => {
                                if (!reorganizedReports[record.employee]) {
                                    reorganizedReports[record.employee] = {};
                                }
                                reorganizedReports[record.employee][record.date] = {
                                    ...record,
                                    workingOn: record.working_on
                                };
                            });
                            dailyReports.value = reorganizedReports;
                            console.log('✅ Daily reports synced:', reportsDataFromDB.length, 'records');
                        }

                        // Generate monthly KPIs after sync
                        generateMonthlyKPIs();

                        saveToStorage();
                        console.log('✅ Sync from Supabase completed successfully');
                        
                    } catch (error) {
                        console.error('❌ Sync from Supabase error:', error);
                        showNotification('Gagal sinkron dari database: ' + error.message, 'error');
                    } finally {
                        isSyncing.value = false;
                    }
                };

                const syncToSupabase = async () => {
                    if (!supabaseConnected.value || isSyncing.value) return;
                    
                    isSyncing.value = true;
                    console.log('🔄 Starting sync to Supabase...');
                    
                    try {
                        // Sync employees (exclude admin)
                        const employeesToSync = employees.value.filter(emp => emp.username !== 'admin');
                        
                        if (employeesToSync.length > 0) {
                            const employeesForDB = employeesToSync.map(emp => ({
                                id: emp.id,
                                username: emp.username,
                                password: emp.password,
                                name: emp.name,
                                email: emp.email || null,
                                position: emp.position || null,
                                status: emp.status || 'active',
                                created_at: emp.created_at || getCurrentDate()
                            }));

                            const { error: empError } = await supabase.value
                                .from('employees')
                                .upsert(employeesForDB, { 
                                    onConflict: 'username',
                                    ignoreDuplicates: false 
                                });

                            if (empError) throw empError;
                            console.log('✅ Employees synced to database');
                        }

                        // Sync KPI data with new recurring fields
                        if (kpiData.value.length > 0) {
                            const kpiForDB = kpiData.value.map(kpi => ({
                                id: kpi.id,
                                title: kpi.title,
                                description: kpi.description || null,
                                assigned_to: kpi.assignedTo,
                                deadline: kpi.deadline,
                                status: kpi.status || 'pending',
                                created_at: kpi.createdAt,
                                created_by: kpi.createdBy,
                                is_recurring: kpi.isRecurring || false,
                                recurring_type: kpi.recurringType || 'once',
                                monthly_deadline_day: kpi.monthlyDeadlineDay || null,
                                parent_recurring_id: kpi.parentRecurringId || null
                            }));

                            const { error: kpiError } = await supabase.value
                                .from('kpi')
                                .upsert(kpiForDB, { 
                                    onConflict: 'id',
                                    ignoreDuplicates: false 
                                });

                            if (kpiError) throw kpiError;
                            console.log('✅ KPI data synced to database');
                        }

                        // Sync attendance data
                        const attendanceArray = [];
                        Object.entries(attendanceData.value).forEach(([username, dates]) => {
                            Object.values(dates).forEach(attendance => {
                                attendanceArray.push({
                                    id: `${attendance.employee}-${attendance.date}`,
                                    employee: attendance.employee,
                                    date: attendance.date,
                                    status: attendance.status,
                                    description: attendance.description || null,
                                    timestamp: attendance.timestamp
                                });
                            });
                        });

                        if (attendanceArray.length > 0) {
                            const { error: attError } = await supabase.value
                                .from('attendance')
                                .upsert(attendanceArray, { 
                                    onConflict: 'id',
                                    ignoreDuplicates: false 
                                });

                            if (attError) throw attError;
                            console.log('✅ Attendance data synced to database');
                        }

                        // Sync daily reports
                        const reportsArray = [];
                        Object.entries(dailyReports.value).forEach(([username, dates]) => {
                            Object.values(dates).forEach(report => {
                                reportsArray.push({
                                    id: `${report.employee}-${report.date}`,
                                    employee: report.employee,
                                    date: report.date,
                                    working_on: report.workingOn,
                                    completed: report.completed,
                                    timestamp: report.timestamp
                                });
                            });
                        });

                        if (reportsArray.length > 0) {
                            const { error: repError } = await supabase.value
                                .from('daily_reports')
                                .upsert(reportsArray, { 
                                    onConflict: 'id',
                                    ignoreDuplicates: false 
                                });

                            if (repError) throw repError;
                            console.log('✅ Daily reports synced to database');
                        }

                        console.log('✅ All data synced successfully to Supabase');
                        showNotification('Data berhasil disinkronkan', 'success');
                        
                    } catch (error) {
                        console.error('❌ Sync to Supabase error:', error);
                        showNotification('Gagal sinkron ke database: ' + error.message, 'error');
                    } finally {
                        isSyncing.value = false;
                    }
                };

                // Storage functions
                const loadFromStorage = () => {
                    try {
                        const savedEmployees = localStorage.getItem('employees');
                        if (savedEmployees) {
                            const parsed = JSON.parse(savedEmployees);
                            employees.value = parsed.filter(emp => emp.username && emp.name);
                        }

                        const savedKPIs = localStorage.getItem('kpiData');
                        if (savedKPIs) {
                            kpiData.value = JSON.parse(savedKPIs);
                        }

                        const savedReports = localStorage.getItem('dailyReports');
                        if (savedReports) {
                            dailyReports.value = JSON.parse(savedReports);
                        }

                        const savedAttendance = localStorage.getItem('attendanceData');
                        if (savedAttendance) {
                            attendanceData.value = JSON.parse(savedAttendance);
                        }

                        const savedDarkMode = localStorage.getItem('darkMode');
                        if (savedDarkMode !== null) {
                            darkMode.value = savedDarkMode === 'true';
                            if (darkMode.value) {
                                document.documentElement.classList.add('dark');
                            }
                        }

                        // Generate monthly KPIs after loading
                        generateMonthlyKPIs();
                    } catch (error) {
                        console.error('Error loading from storage:', error);
                    }
                };

                const saveToStorage = () => {
                    try {
                        localStorage.setItem('employees', JSON.stringify(employees.value));
                        localStorage.setItem('kpiData', JSON.stringify(kpiData.value));
                        localStorage.setItem('dailyReports', JSON.stringify(dailyReports.value));
                        localStorage.setItem('attendanceData', JSON.stringify(attendanceData.value));
                    } catch (error) {
                        console.error('Error saving to storage:', error);
                    }
                };

                const autoSave = async () => {
                    autoSaving.value = true;
                    
                    try {
                        saveToStorage();
                        
                        if (supabaseConnected.value && !isSyncing.value) {
                            setTimeout(async () => {
                                await syncToSupabase();
                            }, 1000);
                        }
                        
                    } catch (error) {
                        console.error('Auto-save error:', error);
                    } finally {
                        setTimeout(() => {
                            autoSaving.value = false;
                        }, 1500);
                    }
                };

                // Authentication
                const login = async () => {
                    loginError.value = '';
                    
                    const user = employees.value.find(emp => 
                        emp.username === credentials.username && 
                        emp.password === credentials.password
                    );
                    
                    if (!user) {
                        loginError.value = 'Username atau password salah';
                        return;
                    }

                    if (user.username !== 'admin' && (user.status || 'active') !== 'active') {
                        loginError.value = 'Akun Anda telah dinonaktifkan. Hubungi administrator.';
                        return;
                    }
                    
                    isLoggingIn.value = true;
                    
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    currentUser.value = user;
                    isAdmin.value = user.username === 'admin';
                    isLoggedIn.value = true;
                    isLoggingIn.value = false;
                    
                    activeTab.value = isAdmin.value ? 'employee-management' : 'my-kpi';
                    
                    // Generate monthly KPIs and sync data after login
                    generateMonthlyKPIs();
                    if (supabaseConnected.value) {
                        await syncFromSupabase();
                    }
                };

                const logout = () => {
                    isLoggedIn.value = false;
                    isAdmin.value = false;
                    currentUser.value = null;
                    credentials.username = '';
                    credentials.password = '';
                    activeTab.value = 'my-kpi';
                    loginError.value = '';
                    resetForms();
                };

                const toggleDarkMode = () => {
                    darkMode.value = !darkMode.value;
                    localStorage.setItem('darkMode', darkMode.value);
                    
                    if (darkMode.value) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                };

                // Employee Management
                const openEmployeeModal = (employee = null) => {
                    editingEmployee.value = employee;
                    if (employee) {
                        employeeForm.name = employee.name;
                        employeeForm.username = employee.username;
                        employeeForm.email = employee.email || '';
                        employeeForm.password = '';
                        employeeForm.position = employee.position || '';
                        employeeForm.status = employee.status || 'active';
                    } else {
                        Object.assign(employeeForm, {
                            name: '',
                            username: '',
                            email: '',
                            password: '',
                            position: '',
                            status: 'active'
                        });
                    }
                    showEmployeePassword.value = false;
                    showEmployeeModal.value = true;
                };

                const closeEmployeeModal = () => {
                    showEmployeeModal.value = false;
                    editingEmployee.value = null;
                    Object.assign(employeeForm, {
                        name: '',
                        username: '',
                        email: '',
                        password: '',
                        position: '',
                        status: 'active'
                    });
                };

                const saveEmployee = async () => {
                    if (!isEmployeeFormValid.value) {
                        showNotification('Lengkapi form dengan benar', 'error');
                        return;
                    }

                    isSubmitting.value = true;

                    try {
                        await new Promise(resolve => setTimeout(resolve, 1000));

                        const form = employeeForm;
                        
                        if (editingEmployee.value) {
                            const index = employees.value.findIndex(emp => emp.username === editingEmployee.value.username);
                            if (index !== -1) {
                                employees.value[index] = {
                                    ...employees.value[index],
                                    name: form.name.trim(),
                                    email: form.email.trim(),
                                    position: form.position.trim(),
                                    status: form.status
                                };

                                if (form.password.trim()) {
                                    employees.value[index].password = form.password.trim();
                                }
                            }
                            showNotification('Data pegawai berhasil diupdate', 'success');
                        } else {
                            const newEmployee = {
                                id: 'emp-' + Date.now(),
                                username: form.username.trim(),
                                password: form.password.trim(),
                                name: form.name.trim(),
                                email: form.email.trim(),
                                position: form.position.trim(),
                                status: form.status,
                                created_at: getCurrentDate()
                            };
                            
                            employees.value.push(newEmployee);
                            showNotification('Pegawai baru berhasil ditambahkan', 'success');
                        }

                        autoSave();
                        closeEmployeeModal();
                        
                    } catch (error) {
                        console.error('Error saving employee:', error);
                        showNotification('Gagal menyimpan data pegawai', 'error');
                    } finally {
                        isSubmitting.value = false;
                    }
                };

                const editEmployee = (employee) => {
                    openEmployeeModal(employee);
                };

                const toggleEmployeeStatus = (employee) => {
                    const newStatus = (employee.status || 'active') === 'active' ? 'inactive' : 'active';
                    const action = newStatus === 'active' ? 'mengaktifkan' : 'menonaktifkan';
                    
                    if (confirm(`Apakah Anda yakin ingin ${action} pegawai ${employee.name}?`)) {
                        employee.status = newStatus;
                        autoSave();
                        showNotification(`Pegawai ${employee.name} berhasil ${action === 'mengaktifkan' ? 'diaktifkan' : 'dinonaktifkan'}`, 'success');
                    }
                };

                // KPI Management
                const updateKPIStatuses = () => {
                    const today = new Date(getCurrentDate());
                    
                    kpiData.value.forEach(kpi => {
                        if (kpi.status !== 'completed' && !kpi.isRecurring) {
                            const deadline = new Date(kpi.deadline);
                            if (deadline < today) {
                                kpi.status = 'overdue';
                            }
                        }
                    });
                };

                const getKPIStatusLabel = (status) => {
                    const labels = {
                        'pending': 'Pending',
                        'in-progress': 'Sedang Dikerjakan',
                        'completed': 'Selesai',
                        'overdue': 'Terlambat'
                    };
                    return labels[status] || 'Unknown';
                };

                const toggleKPIStatus = (kpiId) => {
                    const kpi = kpiData.value.find(k => k.id === kpiId);
                    if (!kpi) return;
                    
                    if (kpi.status === 'completed') {
                        kpi.status = 'in-progress';
                        showNotification('KPI dikembalikan ke status "Sedang Dikerjakan"', 'info');
                    } else {
                        kpi.status = 'completed';
                        showNotification('Selamat! KPI berhasil diselesaikan', 'success');
                    }
                    
                    autoSave();
                };

                // NEW: Enhanced addKPI function with recurring support
                const addKPI = () => {
                    if (!isKPIFormValid.value) {
                        showNotification('Lengkapi semua field yang diperlukan', 'error');
                        return;
                    }
                    
                    const form = kpiForm;
                    
                    if (form.recurringType === 'monthly') {
                        // Create recurring template
                        const recurringTemplate = {
                            id: 'recurring-' + Date.now(),
                            title: form.title,
                            description: form.description,
                            assignedTo: form.assignedTo,
                            deadline: null, // Templates don't have specific deadlines
                            status: 'template', // Special status for templates
                            createdAt: getCurrentDate(),
                            createdBy: currentUser.value.username,
                            isRecurring: true,
                            recurringType: 'monthly',
                            monthlyDeadlineDay: parseInt(form.monthlyDeadlineDay)
                        };
                        
                        kpiData.value.push(recurringTemplate);
                        
                        // Generate this month's KPI immediately
                        const currentMonth = getCurrentMonth();
                        const monthlyDeadline = `${currentMonth}-${form.monthlyDeadlineDay.toString().padStart(2, '0')}`;
                        
                        // Validate the date exists in this month
                        const deadlineDate = new Date(monthlyDeadline);
                        if (deadlineDate.getMonth() === parseInt(currentMonth.split('-')[1]) - 1) {
                            const currentMonthKPI = {
                                id: `monthly-${recurringTemplate.id}-${currentMonth}`,
                                title: form.title,
                                description: form.description,
                                assignedTo: form.assignedTo,
                                deadline: monthlyDeadline,
                                status: 'pending',
                                createdAt: getCurrentDate(),
                                createdBy: currentUser.value.username,
                                isRecurring: false,
                                parentRecurringId: recurringTemplate.id,
                                monthlyDeadlineDay: parseInt(form.monthlyDeadlineDay)
                            };
                            
                            kpiData.value.push(currentMonthKPI);
                        }
                        
                        showNotification('KPI berulang berhasil ditambahkan dan akan otomatis dibuat setiap bulan', 'success');
                    } else {
                        // Create one-time KPI
                        const newKPI = {
                            id: 'kpi-' + Date.now(),
                            title: form.title,
                            description: form.description,
                            assignedTo: form.assignedTo,
                            deadline: form.deadline,
                            status: 'pending',
                            createdAt: getCurrentDate(),
                            createdBy: currentUser.value.username,
                            isRecurring: false,
                            recurringType: 'once'
                        };
                        
                        kpiData.value.push(newKPI);
                        showNotification('KPI baru berhasil ditambahkan', 'success');
                    }
                    
                    resetKPIForm();
                    autoSave();
                };

                const editKPI = (kpi) => {
                    const newTitle = prompt('Edit judul KPI:', kpi.title);
                    if (newTitle && newTitle.trim()) {
                        kpi.title = newTitle.trim();
                        
                        // If editing a recurring template, update all its monthly instances
                        if (kpi.isRecurring) {
                            const monthlyInstances = kpiData.value.filter(k => k.parentRecurringId === kpi.id);
                            monthlyInstances.forEach(instance => {
                                instance.title = newTitle.trim();
                            });
                        }
                        
                        autoSave();
                        showNotification('KPI berhasil diupdate', 'success');
                    }
                };

                const deleteKPI = (kpiId) => {
                    const kpi = kpiData.value.find(k => k.id === kpiId);
                    if (!kpi) return;
                    
                    let confirmMessage = 'Apakah Anda yakin ingin menghapus KPI ini?';
                    
                    if (kpi.isRecurring) {
                        const monthlyCount = kpiData.value.filter(k => k.parentRecurringId === kpiId).length;
                        confirmMessage = `Ini adalah KPI berulang dengan ${monthlyCount} instance bulanan. Apakah Anda yakin ingin menghapus semua KPI ini?`;
                    }
                    
                    if (confirm(confirmMessage)) {
                        if (kpi.isRecurring) {
                            // Delete the recurring template and all its monthly instances
                            kpiData.value = kpiData.value.filter(k => 
                                k.id !== kpiId && k.parentRecurringId !== kpiId
                            );
                            showNotification('KPI berulang dan semua instance bulanannya berhasil dihapus', 'success');
                        } else {
                            // Delete single KPI
                            const index = kpiData.value.findIndex(k => k.id === kpiId);
                            if (index !== -1) {
                                kpiData.value.splice(index, 1);
                                showNotification('KPI berhasil dihapus', 'success');
                            }
                        }
                        
                        autoSave();
                    }
                };

                const resetKPIForm = () => {
                    Object.assign(kpiForm, {
                        title: '',
                        description: '',
                        assignedTo: '',
                        deadline: '',
                        recurringType: 'once',
                        monthlyDeadlineDay: 31
                    });
                };

                // Attendance functions
                const getAttendanceStatusLabel = (status) => {
                    const labels = {
                        'on-time': 'Tepat Waktu',
                        'late': 'Terlambat',
                        'field-duty': 'Tugas Luar',
                        'sick': 'Sakit',
                        'permit': 'Izin'
                    };
                    return labels[status] || 'Unknown';
                };

                const getDescriptionPlaceholder = (status) => {
                    const placeholders = {
                        'late': 'Jelaskan alasan keterlambatan...',
                        'field-duty': 'Jelaskan detail tugas luar kantor...',
                        'sick': 'Jelaskan kondisi sakit...',
                        'permit': 'Jelaskan keperluan izin...'
                    };
                    return placeholders[status] || '';
                };

                const needsDescription = computed(() => 
                    ['late', 'field-duty', 'sick', 'permit'].includes(attendanceForm.status)
                );

                const todayAttendance = computed(() => {
                    if (!currentUser.value) return null;
                    const today = getCurrentDate();
                    return attendanceData.value[currentUser.value.username]?.[today] || null;
                });

                const myAttendanceHistory = computed(() => {
                    if (!currentUser.value) return [];
                    const userAttendance = attendanceData.value[currentUser.value.username] || {};
                    return Object.values(userAttendance).sort((a, b) => new Date(b.date) - new Date(a.date));
                });

                const submitAttendance = async () => {
                    if (!attendanceForm.status) {
                        showNotification('Pilih status absensi', 'error');
                        return;
                    }

                    if (needsDescription.value && !attendanceForm.description.trim()) {
                        showNotification('Keterangan harus diisi untuk status ini', 'error');
                        return;
                    }
                    
                    isSubmitting.value = true;
                    
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    const today = getCurrentDate();
                    const timestamp = new Date().toISOString();
                    
                    if (!attendanceData.value[currentUser.value.username]) {
                        attendanceData.value[currentUser.value.username] = {};
                    }
                    
                    attendanceData.value[currentUser.value.username][today] = {
                        date: today,
                        status: attendanceForm.status,
                        description: attendanceForm.description.trim() || null,
                        timestamp: timestamp,
                        employee: currentUser.value.username
                    };
                    
                    autoSave();
                    resetAttendanceForm();
                    isSubmitting.value = false;
                    showNotification('Absensi berhasil dicatat', 'success');
                };

                const resetAttendanceForm = () => {
                    Object.assign(attendanceForm, {
                        status: '',
                        description: ''
                    });
                };

                // Daily Reports
                const todayReport = computed(() => {
                    if (!currentUser.value) return null;
                    const today = getCurrentDate();
                    return dailyReports.value[currentUser.value.username]?.[today] || null;
                });

                const myReports = computed(() => {
                    if (!currentUser.value) return [];
                    const userReports = dailyReports.value[currentUser.value.username] || {};
                    return Object.values(userReports).sort((a, b) => new Date(b.date) - new Date(a.date));
                });

                const submitDailyReport = async () => {
                    if (!reportForm.workingOn.trim() || !reportForm.completed.trim()) {
                        showNotification('Lengkapi semua field laporan', 'error');
                        return;
                    }
                    
                    isSubmitting.value = true;
                    
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    const today = getCurrentDate();
                    const timestamp = new Date().toISOString();
                    
                    if (!dailyReports.value[currentUser.value.username]) {
                        dailyReports.value[currentUser.value.username] = {};
                    }
                    
                    dailyReports.value[currentUser.value.username][today] = {
                        date: today,
                        workingOn: reportForm.workingOn.trim(),
                        completed: reportForm.completed.trim(),
                        timestamp: timestamp,
                        employee: currentUser.value.username
                    };
                    
                    autoSave();
                    resetReportForm();
                    isSubmitting.value = false;
                    
                    showEditReport.value = false;
                    showNotification(showEditReport.value ? 'Laporan berhasil diupdate' : 'Laporan berhasil dikirim', 'success');
                };

                const resetReportForm = () => {
                    Object.assign(reportForm, {
                        workingOn: '',
                        completed: ''
                    });
                };

                const cancelEditReport = () => {
                    showEditReport.value = false;
                    resetReportForm();
                };

                // Helper functions for admin
                const getEmployeeName = (username) => {
                    const employee = employees.value.find(emp => emp.username === username);
                    return employee ? employee.name : username;
                };

                const getEmployeeTodayAttendance = (username) => {
                    const today = getCurrentDate();
                    return attendanceData.value[username]?.[today] || null;
                };

                const todayOfficeStats = computed(() => {
                    const today = getCurrentDate();
                    const stats = { present: 0, fieldDuty: 0, sick: 0, permit: 0 };
                    
                    activeEmployees.value.forEach(employee => {
                        const attendance = attendanceData.value[employee.username]?.[today];
                        if (attendance) {
                            switch (attendance.status) {
                                case 'on-time':
                                case 'late':
                                    stats.present++;
                                    break;
                                case 'field-duty':
                                    stats.fieldDuty++;
                                    break;
                                case 'sick':
                                    stats.sick++;
                                    break;
                                case 'permit':
                                    stats.permit++;
                                    break;
                            }
                        }
                    });
                    
                    return stats;
                });

                // Admin computed properties
                const completedKPIs = computed(() => 
                    kpiData.value.filter(kpi => kpi.status === 'completed').length
                );

                const inProgressKPIs = computed(() => 
                    kpiData.value.filter(kpi => kpi.status === 'in-progress').length
                );

                const overdueKPIs = computed(() => 
                    kpiData.value.filter(kpi => kpi.status === 'overdue').length
                );

                // NEW: Recurring KPIs count
                const recurringKPIs = computed(() => 
                    kpiData.value.filter(kpi => kpi.isRecurring && kpi.status === 'template').length
                );

                const filteredKPIData = computed(() => {
                    let filtered = kpiData.value.filter(kpi => kpi.status !== 'template'); // Hide templates from main list
                    
                    if (kpiFilter.employee) {
                        filtered = filtered.filter(kpi => kpi.assignedTo === kpiFilter.employee);
                    }
                    
                    if (kpiFilter.type) {
                        if (kpiFilter.type === 'monthly') {
                            filtered = filtered.filter(kpi => kpi.parentRecurringId || kpi.isRecurring);
                        } else {
                            filtered = filtered.filter(kpi => !kpi.parentRecurringId && !kpi.isRecurring);
                        }
                    }
                    
                    return filtered;
                });

                const filteredDailyReports = computed(() => {
                    const allReports = [];
                    
                    Object.entries(dailyReports.value).forEach(([username, userReports]) => {
                        Object.values(userReports).forEach(report => {
                            allReports.push({
                                ...report,
                                id: `${username}-${report.date}`,
                                employee: username
                            });
                        });
                    });

                    let filtered = allReports;

                    if (reportFilter.date) {
                        filtered = filtered.filter(report => report.date === reportFilter.date);
                    }

                    if (reportFilter.employee) {
                        filtered = filtered.filter(report => report.employee === reportFilter.employee);
                    }

                    return filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                });

                const getEmployeeKPICount = (username, status = null) => {
                    const employeeKPIs = kpiData.value.filter(kpi => 
                        kpi.assignedTo === username && kpi.status !== 'template'
                    );
                    if (status) {
                        return employeeKPIs.filter(kpi => kpi.status === status).length;
                    }
                    return employeeKPIs.length;
                };

                // NEW: Get recurring KPI count for employee
                const getEmployeeRecurringKPICount = (username) => {
                    return kpiData.value.filter(kpi => 
                        kpi.assignedTo === username && kpi.parentRecurringId
                    ).length;
                };

                const getEmployeeKPIProgress = (username) => {
                    const employeeKPIs = kpiData.value.filter(kpi => 
                        kpi.assignedTo === username && kpi.status !== 'template'
                    );
                    if (employeeKPIs.length === 0) return 0;
                    const completed = employeeKPIs.filter(kpi => kpi.status === 'completed').length;
                    return Math.round((completed / employeeKPIs.length) * 100);
                };

                // Attendance recap
                const filteredAttendanceRecords = computed(() => {
                    const allAttendance = [];
                    
                    Object.entries(attendanceData.value).forEach(([username, userAttendance]) => {
                        Object.values(userAttendance).forEach(attendance => {
                            allAttendance.push({
                                ...attendance,
                                id: `${username}-${attendance.date}`,
                                employee: username
                            });
                        });
                    });

                    let filtered = allAttendance;

                    if (attendanceFilter.month) {
                        const [year, month] = attendanceFilter.month.split('-');
                        filtered = filtered.filter(attendance => {
                            const [attYear, attMonth] = attendance.date.split('-');
                            return attYear === year && attMonth === month;
                        });
                    }

                    if (attendanceFilter.employee) {
                        filtered = filtered.filter(attendance => attendance.employee === attendanceFilter.employee);
                    }

                    return filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
                });

                const monthlyAttendanceStats = computed(() => {
                    const stats = {
                        onTime: 0,
                        late: 0,
                        fieldDuty: 0,
                        sick: 0,
                        permit: 0,
                        absent: 0
                    };

                    filteredAttendanceRecords.value.forEach(attendance => {
                        switch (attendance.status) {
                            case 'on-time':
                                stats.onTime++;
                                break;
                            case 'late':
                                stats.late++;
                                break;
                            case 'field-duty':
                                stats.fieldDuty++;
                                break;
                            case 'sick':
                                stats.sick++;
                                break;
                            case 'permit':
                                stats.permit++;
                                break;
                        }
                    });

                    return stats;
                });

                const getEmployeeMonthlyAttendance = (username) => {
                    const stats = {
                        'on-time': 0,
                        'late': 0,
                        'field-duty': 0,
                        'sick': 0,
                        'permit': 0,
                        'total': 0
                    };

                    if (attendanceFilter.month) {
                        const [year, month] = attendanceFilter.month.split('-');
                        const userAttendance = attendanceData.value[username] || {};
                        
                        Object.entries(userAttendance).forEach(([date, attendance]) => {
                            const [attYear, attMonth] = date.split('-');
                            if (attYear === year && attMonth === month) {
                                stats[attendance.status]++;
                                if (['on-time', 'late', 'field-duty'].includes(attendance.status)) {
                                    stats.total++;
                                }
                            }
                        });
                    }

                    return stats;
                };

                const getWorkDaysInMonth = (year, month) => {
                    let workDays = 0;
                    const date = new Date(year, month - 1, 1);
                    
                    while (date.getMonth() === month - 1) {
                        const dayOfWeek = date.getDay();
                        if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                            workDays++;
                        }
                        date.setDate(date.getDate() + 1);
                    }
                    
                    return workDays;
                };

                const getEmployeeAttendancePercentage = (username) => {
                    if (!attendanceFilter.month) return 0;
                    
                    const [year, month] = attendanceFilter.month.split('-');
                    const workDays = getWorkDaysInMonth(year, month);
                    const stats = getEmployeeMonthlyAttendance(username);
                    
                    if (workDays === 0) return 0;
                    
                    const attendedDays = stats.total;
                    return Math.round((attendedDays / workDays) * 100);
                };

                const resetForms = () => {
                    resetKPIForm();
                    resetReportForm();
                    resetAttendanceForm();
                };

                // Test function
                const testSync = async () => {
                    console.log('🧪 Testing sync...');
                    await syncToSupabase();
                    setTimeout(async () => {
                        await syncFromSupabase();
                    }, 2000);
                };

                // Lifecycle
                onMounted(async () => {
                    console.log('🚀 App is mounting...');
                    
                    loadFromStorage();
                    await initSupabase();
                    
                    updateCurrentTime();
                    setInterval(updateCurrentTime, 1000);
                    
                    // Auto-save interval
                    setInterval(() => {
                        if (isLoggedIn.value && !autoSaving.value) {
                            saveToStorage();
                        }
                    }, 30000);
                    
                    // Periodic sync and monthly KPI generation
                    setInterval(async () => {
                        if (supabaseConnected.value && !isSyncing.value && isLoggedIn.value) {
                            generateMonthlyKPIs();
                            await syncFromSupabase();
                        }
                    }, 300000); // 5 minutes
                    
                    // Daily check for monthly KPI generation
                    setInterval(() => {
                        if (isLoggedIn.value) {
                            generateMonthlyKPIs();
                        }
                    }, 3600000); // 1 hour
                    
                    setTimeout(() => {
                        loading.value = false;
                    }, 1500);
                });

                // Cleanup
                watch(isLoggedIn, (newVal) => {
                    if (!newVal && realtimeSubscriptions.value.length > 0) {
                        realtimeSubscriptions.value.forEach(sub => {
                            if (supabase.value && sub) {
                                supabase.value.removeChannel(sub);
                            }
                        });
                        realtimeSubscriptions.value = [];
                    }
                });

                return {
                    // Core state
                    loading,
                    isLoggedIn,
                    isAdmin,
                    currentUser,
                    activeTab,
                    darkMode,
                    currentTime,
                    autoSaving,
                    isSubmitting,
                    isLoggingIn,
                    loginError,
                    
                    // Supabase
                    supabaseConnected,
                    isSyncing,
                    syncStatusText,
                    
                    // UI state
                    showEmployeeModal,
                    editingEmployee,
                    showEmployeePassword,
                    showEditReport,
                    showPassword,
                    
                    // Forms
                    credentials,
                    employeeForm,
                    kpiForm,
                    kpiFilter,
                    attendanceForm,
                    reportForm,
                    reportFilter,
                    attendanceFilter,
                    
                    // Data
                    employees,
                    kpiData,
                    dailyReports,
                    attendanceData,
                    notifications,
                    
                    // Computed
                    activeEmployees,
                    nonAdminEmployees,
                    activeEmployeesCount,
                    todayPresentCount,
                    pendingKPICount,
                    completedKPIs,
                    inProgressKPIs,
                    overdueKPIs,
                    recurringKPIs,
                    myKPIs,
                    filteredKPIData,
                    kpiProgress,
                    completedKPICount: computed(() => myKPIs.value.filter(kpi => kpi.status === 'completed').length),
                    todayAttendance,
                    todayReport,
                    myAttendanceHistory,
                    myReports,
                    todayOfficeStats,
                    needsDescription,
                    isEmployeeFormValid,
                    isKPIFormValid,
                    filteredDailyReports,
                    filteredAttendanceRecords,
                    monthlyAttendanceStats,
                    
                    // Methods
                    getCurrentDate,
                    getCurrentMonth,
                    getCurrentDateString,
                    formatDate,
                    formatDateTime,
                    toggleDarkMode,
                    showNotification,
                    removeNotification,
                    getNotificationClass,
                    getNotificationIcon,
                    login,
                    logout,
                    openEmployeeModal,
                    closeEmployeeModal,
                    saveEmployee,
                    editEmployee,
                    toggleEmployeeStatus,
                    getEmployeeName,
                    getEmployeeKPICount,
                    getEmployeeRecurringKPICount,
                    getEmployeeKPIProgress,
                    getEmployeeMonthlyAttendance,
                    getEmployeeAttendancePercentage,
                    updateKPIStatuses,
                    getKPIStatusLabel,
                    toggleKPIStatus,
                    addKPI,
                    editKPI,
                    deleteKPI,
                    resetKPIForm,
                    getAttendanceStatusLabel,
                    getDescriptionPlaceholder,
                    submitAttendance,
                    resetAttendanceForm,
                    getEmployeeTodayAttendance,
                    submitDailyReport,
                    resetReportForm,
                    cancelEditReport,
                    resetForms,
                    testSync,
                    syncToSupabase,
                    syncFromSupabase,
                    generateMonthlyKPIs
                };
            }
        });

        app.mount('#app');
    </script>
</body>
</html>
